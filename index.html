<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø¨ÙˆØª ÙˆØ§ØªØ³Ø§Ø¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--blue:#0a84ff;--green:#34c759;--red:#ff3b30;--bg:#f7f7fb;--card:#fff;--muted:#64748b}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Tajawal",Arial,sans-serif;color:#0f172a}
    header{background:var(--blue);color:#fff;padding:14px 16px;text-align:center;font-weight:800}
    main{max-width:920px;margin:16px auto;padding:0 12px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 8px 24px rgba(2,6,23,.06);padding:16px;margin-bottom:12px}
    h3{margin:0 0 10px;font-size:18px}
    label{display:block;font-weight:700;margin:.4rem 0}
    input,button,select{border-radius:12px;border:1px solid #e5e7eb;padding:10px 12px;font-size:15px}
    input,select{width:100%}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{background:var(--blue);color:#fff;border:none;cursor:pointer;font-weight:800}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-ghost{background:#eef2ff;color:#1e293b;border:0}
    .btn-red{background:var(--red)}
    .muted{color:var(--muted);font-size:13px}
    .state{display:inline-flex;gap:6px;align-items:center;background:#f3f4f6;padding:6px 10px;border-radius:999px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:860px){.grid{grid-template-columns:1fr}}
    /* Modal */
    #qrOverlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
    .qrCard{background:#fff;border-radius:16px;max-width:380px;width:92vw;padding:16px;box-shadow:0 20px 50px rgba(0,0,0,.2)}
    .qrHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .qrBox{min-height:300px;display:flex;align-items:center;justify-content:center;border:1px solid #eef2f7;border-radius:12px;overflow:hidden}
  </style>
</head>
<body>
  <header>ğŸ“± Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø¨ÙˆØª ÙˆØ§ØªØ³Ø§Ø¨</header>
  <main>

    <div class="grid">
      <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§Ø¯Ù… -->
      <section class="card">
        <h3>ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§Ø¯Ù…</h3>
        <label>API Base URL</label>
        <input id="apiBase" placeholder="https://your-backend.onrender.com" />
        <label>API Key</label>
        <input id="apiKey" type="password" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…ÙØªØ§Ø­" />
        <div class="row">
          <button class="btn btn-ghost" id="pingServer">ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„</button>
          <span class="state">Ø§Ù„Ø­Ø§Ù„Ø©: <strong id="serviceHealth">ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ</strong></span>
        </div>
        <div class="muted" id="pingResult">â€”</div>
      </section>

      <!-- Ø§ØªØµØ§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ -->
      <section class="card">
        <h3>ğŸŸ¢ Ø§ØªØµØ§Ù„ ÙˆØ§ØªØ³Ø§Ø¨</h3>
        <div class="row">
          <button class="btn" id="connectBtn">Ø±Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨ (Ù…Ø³Ø­ QR)</button>
          <span class="state">Ø¬Ù„Ø³Ø©: <strong id="status">ØºÙŠØ± Ù…ØªØµÙ„</strong></span>
        </div>
        <p class="muted">Ø¨Ø¹Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ ÙŠÙ…ÙƒÙ†Ùƒ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ø¨Ø§Ùƒ-Ø¥Ù†Ø¯.</p>
      </section>
    </div>

    <!-- ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª/Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù„Ø§Ø­Ù‚Ù‹Ø§ ÙˆÙ†Ø­Ù† Ù†Ø·ÙˆÙ‘Ø±Ù‡Ø§ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ© -->

  </main>

  <!-- Modal QR -->
  <div id="qrOverlay">
    <div class="qrCard" role="dialog" aria-modal="true">
      <div class="qrHead">
        <strong>Ø§Ù…Ø³Ø­ Ø±Ù…Ø² ÙˆØ§ØªØ³Ø§Ø¨</strong>
        <button id="closeQr" class="btn btn-red">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div id="qrBox" class="qrBox">
        <span class="muted">Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ QR...</span>
      </div>
      <div id="qrHint" class="muted" style="margin-top:8px">Ø§ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ â†’ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© â†’ Ø§Ø±Ø¨Ø· Ø¬Ù‡Ø§Ø²Ù‹Ø§</div>
    </div>
  </div>

  <script>
  /* (B) Ø²Ø± ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ */
  (function () {
    const btn = document.getElementById('pingServer');
    const resEl = document.getElementById('pingResult');
    const healthEl = document.getElementById('serviceHealth');
    if (!btn || !resEl || !healthEl) return;

    btn.addEventListener('click', async () => {
      const base = (document.getElementById('apiBase').value || '').trim().replace(/\/$/,'');
      const key  = (document.getElementById('apiKey').value  || '').trim();
      if(!base || !key){ resEl.textContent='âŒ Ø£Ø¯Ø®Ù„ API Base Ùˆ API Key'; return; }
      resEl.textContent = 'â³ Ø¬Ø§Ø±Ù Ø§Ù„ÙØ­Øµ...';
      try {
        const res  = await fetch(base + '/health', { headers: { Authorization: 'Bearer ' + key } });
        resEl.textContent    = res.ok ? 'âœ… Ù…ØªØµÙ„' : ('âŒ ' + res.status);
        healthEl.textContent = res.ok ? 'Ø³Ù„ÙŠÙ…' : 'ØºÙŠØ± Ù…ØªØ§Ø­';
      } catch (e) {
        resEl.textContent    = 'âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ' + e.message;
        healthEl.textContent = 'ØºÙŠØ± Ù…ØªØ§Ø­';
      }
    });
  })();

  /* Ù…ÙˆØ¯Ø§Ù„ QR ÙˆØ±Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨ */
  (function(){
    const apiBaseEl = document.getElementById('apiBase');
    const apiKeyEl  = document.getElementById('apiKey');
    const connectBtn = document.getElementById('connectBtn');
    const qrOverlay = document.getElementById('qrOverlay');
    const qrBox = document.getElementById('qrBox');
    const closeQr = document.getElementById('closeQr');
    const statusEl = document.getElementById('status');

    let pollTimer = null;

    function openQR(){ qrOverlay.style.display = 'flex'; }
    function closeQR(){
      qrOverlay.style.display = 'none';
      if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
    }
    closeQr?.addEventListener('click', closeQR);

    async function fetchQR(base, key){
      try{
        const res = await fetch(base + '/session/qr', { headers: { Authorization: 'Bearer ' + key }});
        if (res.ok) {
          const data = await res.json();
          if (data.qr) {
            qrBox.innerHTML = `<img src="${data.qr}" alt="QR" style="width:100%;max-width:320px;display:block">`;
            return 'qr';
          }
          if (data.message === 'Already connected') return 'connected';
        }
      }catch(_){}
      qrBox.innerHTML = `<span class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ QR Ø­Ø§Ù„ÙŠÙ‹Ø§â€¦ Ø³ÙŠÙØ¹Ø§Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</span>`;
      return 'waiting';
    }

    async function checkReady(base, key){
      try{
        const res = await fetch(base + '/health', { headers: { Authorization: 'Bearer ' + key }});
        if (!res.ok) return false;
        const data = await res.json();
        return !!data.isReady;
      }catch(_){ return false; }
    }

    async function startQrFlow(){
      const base = (apiBaseEl.value || '').trim().replace(/\/$/,'');
      const key  = (apiKeyEl.value  || '').trim();
      if (!base || !key) return alert('Ø£Ø¯Ø®Ù„ API Base Ùˆ API Key');
      openQR();
      const first = await fetchQR(base, key);
      if (first === 'connected') {
        qrBox.innerHTML = '<span class="muted">Ù…ØªØµÙ„ Ù…Ø³Ø¨Ù‚Ù‹Ø§ âœ…</span>';
        statusEl.textContent = 'Ù…ØªØµÙ„';
        setTimeout(closeQR, 900);
        return;
      }
      pollTimer = setInterval(async () => {
        const ready = await checkReady(base, key);
        if (ready) {
          qrBox.innerHTML = '<span class="muted">ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ âœ…</span>';
          statusEl.textContent = 'Ù…ØªØµÙ„';
          clearInterval(pollTimer); pollTimer = null;
          setTimeout(closeQR, 800);
          return;
        }
        await fetchQR(base, key);
      }, 3000);
    }

    connectBtn?.addEventListener('click', startQrFlow);
  })();
  </script>
  <script>
(function(){
  const statusEl   = document.getElementById('status');       // Ø§Ù„Ù†Øµ: Ù…ØªØµÙ„/ØºÙŠØ± Ù…ØªØµÙ„
  const healthEl   = document.getElementById('serviceHealth'); // Ø§Ù„Ù†Øµ: Ø³Ù„ÙŠÙ…/ØºÙŠØ± Ù…ØªØ§Ø­
  const pingResult = document.getElementById('pingResult');    // Ù†ØªÙŠØ¬Ø© ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„
  const apiBaseEl  = document.getElementById('apiBase');
  const apiKeyEl   = document.getElementById('apiKey');

  let watchTimer = null;

  function setSessionUI(isReady){
    if (!statusEl) return;
    statusEl.textContent = isReady ? 'Ù…ØªØµÙ„' : 'ØºÙŠØ± Ù…ØªØµÙ„';
    // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ù†Ù‚Ø·Ø© Ù…Ù„ÙˆÙ‘Ù†Ø©ØŒ Ø¨Ø¯Ù‘Ù„Ù‡Ø§ Ù‡Ù†Ø§ (Ù…Ø«Ø§Ù„ Ø¨Ø³ÙŠØ·):
    // document.getElementById('sessionDot').style.background = isReady ? '#34c759' : '#ff3b30';
  }

  async function fetchHealth(){
    const base = (apiBaseEl.value||'').trim().replace(/\/$/,'');
    const key  = (apiKeyEl.value ||'').trim();
    if(!base || !key) return;
    try{
      const res  = await fetch(base + '/health', { headers: { Authorization: 'Bearer ' + key }});
      if(!res.ok){ setSessionUI(false); healthEl && (healthEl.textContent='ØºÙŠØ± Ù…ØªØ§Ø­'); return; }
      const data = await res.json();
      setSessionUI(!!data.isReady);
      healthEl && (healthEl.textContent = 'Ø³Ù„ÙŠÙ…');
      pingResult && (pingResult.textContent = 'âœ… Ù…ØªØµÙ„');
    }catch(_){
      setSessionUI(false);
      healthEl && (healthEl.textContent='ØºÙŠØ± Ù…ØªØ§Ø­');
      pingResult && (pingResult.textContent='âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„');
    }
  }

  // Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
  function startStatusWatcher(){
    if (watchTimer) clearInterval(watchTimer);
    fetchHealth(); // ÙØ­Øµ ÙÙˆØ±ÙŠ Ø£ÙˆÙ„Ø§Ù‹
    watchTimer = setInterval(fetchHealth, 5000);
  }

  // Ø´ØºÙ‘Ù„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙˆØ¨Ø¹Ø¯ Ø£ÙŠ ÙØ­Øµ/Ø±Ø¨Ø·
  startStatusWatcher();

  // Ù„Ùˆ Ø²Ø± ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø®Ù„Ù‘ØµØªÙ‡ ÙŠØ¹ÙŠØ¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„ÙØ­Øµ
  const pingBtn = document.getElementById('pingServer');
  if (pingBtn) {
    pingBtn.addEventListener('click', () => {
      setTimeout(startStatusWatcher, 300); // Ø£Ø¹ÙØ¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨
    });
  }

  // ÙˆÙ„Ùˆ Ø²Ø± Ø±Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø´ØºÙ‘Ù„ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ Ø¨Ø¹Ø¯ Ù…Ø§ ØªØºÙ„Ù‚ Ù…ÙˆØ¯Ø§Ù„ QR
  const closeQr = document.getElementById('closeQr');
  if (closeQr) {
    closeQr.addEventListener('click', () => {
      setTimeout(startStatusWatcher, 800);
    });
  }
})();
</script>
</body>
</html>
