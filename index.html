<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>تشخيص بوت واتساب (MVP)</title>
<style>
  body{font-family:system-ui,"Tajawal",sans-serif;background:#f5f7fb;margin:0;padding:16px;color:#111}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px;max-width:720px;margin:12px auto;box-shadow:0 4px 14px rgba(0,0,0,.05)}
  h3{margin:0 0 10px}
  button,input,select{font-size:15px;padding:10px;border-radius:10px;border:1px solid #e5e7eb}
  button{cursor:pointer;background:#0a84ff;color:#fff;border:none}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  #log{white-space:pre-wrap;background:#0b1020;color:#d1e2ff;padding:10px;border-radius:10px;max-height:220px;overflow:auto}
  .ok{color:#0a7a3d} .err{color:#b91c1c}
  .tag{display:inline-block;background:#eef2ff;padding:4px 10px;border-radius:999px;margin:2px}
</style>
</head>
<body>

<div class="card">
  <h3>إعدادات الاتصال</h3>
  <div class="row">
    <input id="apiBase" style="min-width:260px;flex:1" />
    <input id="apiKey"  style="min-width:220px;flex:1" />
    <button id="saveCfg">حفظ</button>
    <button id="check">فحص الاتصال</button>
  </div>
  <div>الحالة: <b id="status">—</b></div>
</div>

<div class="card">
  <h3>الجلسة</h3>
  <div class="row">
    <button id="showQR">عرض QR</button>
    <button id="getGroups">جلب المجموعات</button>
    <button id="saveGroups">حفظ المجموعات المختارة</button>
  </div>
  <div id="qrBox" style="margin-top:10px"></div>
  <div id="groupsBox" style="margin-top:10px"></div>
</div>

<div class="card">
  <h3>تشغيل</h3>
  <div class="row">
    <input id="emoji" value="✅" style="width:80px">
    <input id="rateLimit" type="number" value="20" style="width:120px" title="ردود/دقيقة">
    <input id="cooldown"  type="number" value="3"  style="width:120px" title="مهلة ثواني">
    <label><input type="checkbox" id="enableOCR"> OCR</label>
  </div>
  <div class="row" style="margin-top:10px">
    <button id="start">بدء</button>
    <button id="stop" style="background:#ff3b30">إيقاف</button>
    <span>تشغيل: <b id="running">—</b></span>
  </div>
</div>

<div class="card">
  <h3>Log</h3>
  <div id="log">...</div>
</div>

<script>
const LS='mvp_cfg';
const cfg = JSON.parse(localStorage.getItem(LS)||'{}');
const $=id=>document.getElementById(id);
const log=(m,cls='')=>{const x=$('log');x.innerHTML += (cls?`<span class="${cls}">`:'')+m+(cls?'</span>':'')+"\n"; x.scrollTop=x.scrollHeight;};

$('apiBase').value = cfg.apiBase || 'https://whatsapp-bot-backend-1jdi.onrender.com';
$('apiKey').value  = cfg.apiKey  || 'ahmad_SUPER_secret_2025';

$('saveCfg').onclick=()=>{ localStorage.setItem(LS, JSON.stringify({ apiBase:$('apiBase').value, apiKey:$('apiKey').value })); log('✔️ حُفظت الإعدادات','ok'); };

async function GET(p){ const r=await fetch($('apiBase').value+p,{headers:{Authorization:'Bearer '+$('apiKey').value}}); if(r.status===401) throw new Error('Unauthorized'); return r.json(); }
async function POST(p,body){ const r=await fetch($('apiBase').value+p,{method:'POST',headers:{Authorization:'Bearer '+$('apiKey').value,'Content-Type':'application/json'},body:JSON.stringify(body||{})}); const d=await r.json().catch(()=>({})); if(!r.ok) throw new Error(d.error||('HTTP '+r.status)); return d; }

$('check').onclick=async()=>{
  try{ const d=await fetch($('apiBase').value+'/health').then(r=>r.json()); $('status').textContent = d.isReady?'متصل':'غير متصل'; $('running').textContent = d.running?'شغّال':'متوقف'; log('✅ /health ok','ok'); }
  catch(e){ $('status').textContent='خطأ'; log('❌ /health: '+e.message,'err'); }
};

$('showQR').onclick=async()=>{
  try{ const d=await GET('/session/qr'); if(d.qr){ $('qrBox').innerHTML=`<img src="${d.qr}" style="max-width:320px">`; log('✅ QR جاهز','ok'); } else { $('qrBox').textContent = d.message || 'لا يوجد QR'; } }
  catch(e){ log('❌ /session/qr: '+e.message,'err'); }
};

let all=[], selected=[];
$('getGroups').onclick=async()=>{
  try{
    const list=await GET('/chats'); all=list; selected=[]; const box=$('groupsBox'); box.innerHTML='';
    list.forEach(g=>{
      const id='g_'+g.id.replace(/[@.:]/g,'_');
      box.innerHTML += `<label style="display:block;margin:4px 0"><input type="checkbox" id="${id}" data-id="${g.id}"> ${g.name} <span style="color:#888">(${g.participants||0})</span></label>`;
    });
    box.querySelectorAll('input[type=checkbox]').forEach(ch=>{
      ch.onchange = e => { const id=e.target.getAttribute('data-id'); if(e.target.checked){ if(!selected.includes(id)) selected.push(id); } else { selected = selected.filter(x=>x!==id); } };
    });
    log('✅ جلب المجموعات ('+list.length+')','ok');
  }catch(e){ log('❌ /chats: '+e.message,'err'); }
};

$('saveGroups').onclick=async()=>{
  try{ await POST('/groups/select',{ids:selected}); log('✅ تم حفظ المجموعات المختارة','ok'); }
  catch(e){ log('❌ /groups/select: '+e.message,'err'); }
};

$('start').onclick=async()=>{
  try{
    const body={
      clients: JSON.parse(localStorage.getItem('clients')||'[]'),
      settings:{
        emoji: $('emoji').value || '✅',
        rateLimit: Math.max(1,+$('rateLimit').value||20),
        cooldown:  Math.max(0,+$('cooldown').value||3),
        enableOCR: !!$('enableOCR').checked,
        archive:{ enabled:false, startAt:null, limit:200 }
      }
    };
    const d=await POST('/bot/start', body);
    $('running').textContent = d.running?'شغّال':'متوقف';
    log('✅ /bot/start','ok');
  }catch(e){ log('❌ /bot/start: '+e.message,'err'); }
};

$('stop').onclick=async()=>{
  try{ const d=await POST('/bot/stop',{}); $('running').textContent = d.running?'شغّال':'متوقف'; log('✅ /bot/stop','ok'); }
  catch(e){ log('❌ /bot/stop: '+e.message,'err'); }
};
</script>
</body>
</html>
