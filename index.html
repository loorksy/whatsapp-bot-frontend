<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>بوت واتساب — iOS</title>
<style>
  :root{
    --bg:#f2f2f7; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --border:#e5e7eb;
    --blue:#0a84ff; --green:#34c759; --red:#ff3b30; --shadow:0 8px 24px rgba(2,6,23,.06);
    --chip:#f3f4f6; --ghost:#eef2ff;
  }
  .dark{
    --bg:#0b0f14; --card:#0f141a; --text:#e5e7eb; --muted:#94a3b8; --border:#1f2937;
    --blue:#0a84ff; --green:#34c759; --red:#ff5547; --shadow:0 8px 30px rgba(0,0,0,.45);
    --chip:#111827; --ghost:#1f2937;
  }
  @media (prefers-color-scheme: dark){ :root{ color-scheme:dark } }

  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Tajawal",Arial,sans-serif}

  header{position:sticky;top:0;z-index:10;background:var(--card);padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:8px}
  header h1{margin:0;font-size:18px;font-weight:800}
  .badge{display:inline-flex;gap:6px;align-items:center;background:var(--chip);border-radius:999px;padding:6px 10px;font-size:13px}

  main{max-width:980px;margin:12px auto;padding:0 12px 68px}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}

  .card{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:14px}
  h3{margin:0 0 8px;font-size:16px}
  .muted{color:var(--muted);font-size:13px}

  label{display:block;font-weight:700;margin:.35rem 0 .25rem}
  input,select,textarea,button{width:100%;font-size:15px;border:1px solid var(--border);border-radius:12px;background:var(--card);color:var(--text);padding:11px 12px}
  textarea{min-height:96px;resize:vertical}

  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .stack{flex-direction:column} .stack>*{width:100%}
  @media(min-width:900px){.stack{flex-direction:row}.stack>*{width:auto}}

  .btn{background:var(--blue);color:#fff;border:none;border-radius:12px;padding:11px 14px;font-weight:800;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn-ghost{background:var(--ghost);color:var(--text)}
  .btn-green{background:var(--green)} .btn-red{background:var(--red)}
  .state{display:inline-flex;gap:6px;align-items:center;background:var(--chip);padding:6px 10px;border-radius:999px}

  .btn-col{display:grid;grid-template-columns:1fr;gap:8px}
  @media(min-width:900px){.btn-col{grid-template-columns:repeat(3,auto)}}

  .switch{position:relative;width:52px;height:30px} .switch input{display:none}
  .track{position:absolute;inset:0;background:var(--border);border-radius:999px;transition:.2s}
  .thumb{position:absolute;top:3px;right:3px;width:24px;height:24px;background:#fff;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,.15);transition:.2s}
  .dark .thumb{background:#e5e7eb}
  .switch input:checked + .track{background:var(--green)} .switch input:checked + .track .thumb{right:25px}

  #groupsTags{display:flex;gap:6px;flex-wrap:wrap}
  .tag{background:var(--ghost);border-radius:999px;padding:4px 10px;font-size:13px}

  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:60}
  .sheet{background:var(--card);width:min(92vw,380px);max-height:86vh;border-radius:18px;box-shadow:0 20px 50px rgba(0,0,0,.35);overflow:hidden}
  .sheet-lg{width:min(94vw,780px)}
  .sheet .head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border)}
  .sheet .body{padding:12px 14px}
  .sheet .foot{padding:12px 14px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:space-between;align-items:center}

  #toast{position:fixed;bottom:16px;right:16px;left:16px;margin:auto;max-width:420px;background:#111827;color:#fff;padding:12px 14px;border-radius:14px;box-shadow:var(--shadow);display:none;z-index:80}
  #toast.ok{background:#065f46} #toast.err{background:#7f1d1d}
</style>
</head>
<body>
  <header>
    <h1>بوت واتساب — iOS</h1>
    <div class="row" style="gap:10px">
      <div class="badge">جلسة: <strong id="status">غير متصل</strong></div>
      <label class="switch" title="الوضع الداكن">
        <input id="darkToggle" type="checkbox"><span class="track"><span class="thumb"></span></span>
      </label>
    </div>
  </header>

  <main>
    <div class="grid">
      <!-- الجلسة والمجموعات -->
      <section class="card">
        <h3>🟢 الجلسة</h3>
        <div class="btn-col">
          <button class="btn" id="connectBtn">اتصال (QR)</button>
          <button class="btn btn-ghost" id="pickGroups">مجموعات</button>
          <button class="btn btn-ghost" id="refreshGroups">تحديث</button>
        </div>
        <div class="state" style="margin-top:8px">الحالة: <strong id="statusChip">غير متصل</strong></div>
        <div class="muted" style="margin-top:8px">المحدد:</div>
        <div id="groupsTags"></div>
      </section>

      <!-- العملاء -->
      <section class="card">
        <h3>👤 العملاء</h3>
        <label>لصق دفعة (سطر/عميل، أو "الاسم,الإيموجي")</label>
        <textarea id="bulkClients" placeholder="أحمد محمد عيسى,✅"></textarea>
        <div class="btn-col" style="margin-top:8px">
          <button class="btn btn-ghost" id="applyClients">حفظ</button>
          <button class="btn btn-ghost" id="clearClients">مسح</button>
        </div>
        <label style="margin-top:10px">CSV (Sheets)</label>
        <input id="sheetUrl" placeholder="رابط CSV">
        <button class="btn btn-ghost" id="importSheet" style="margin-top:8px">استيراد</button>
        <p class="muted">القائمة تُحفظ محليًا لهذا الجهاز.</p>
      </section>
    </div>

    <div class="grid">
      <!-- التفاعل -->
      <section class="card">
        <h3>⚡ التفاعل</h3>
        <div class="stack row">
          <select id="mode">
            <option value="emoji">إيموجي</option>
            <option value="text">نص</option>
          </select>
          <input id="emoji" value="✅" />
          <input id="replyText" value="تم ✅" style="display:none" />
        </div>

        <div class="stack row" style="margin-top:8px">
          <input id="threshold" type="number" min="40" max="95" value="60" placeholder="تطابق %"/>
          <input id="cooldown"  type="number" min="0"  max="300" value="3"  placeholder="مهلة ث"/>
          <input id="rateLimit" type="number" min="1"  max="120" value="20" placeholder="/دقيقة"/>
        </div>

        <input id="mustInclude" placeholder="يتطلب كلمات" style="margin-top:8px">
        <input id="mustExclude" placeholder="يستبعد كلمات" style="margin-top:8px">

        <div class="stack row" style="margin-top:8px">
          <label class="switch"><input id="normalizeArabic" type="checkbox" checked><span class="track"><span class="thumb"></span></span></label><span class="muted">تطبيع عربي</span>
          <label class="switch"><input id="enableOCR" type="checkbox"><span class="track"><span class="thumb"></span></span></label><span class="muted">OCR صور</span>
          <label class="switch"><input id="instantEyes" type="checkbox" checked><span class="track"><span class="thumb"></span></span></label><span class="muted">👀 فوري</span>
          <label class="switch"><input id="dryRun" type="checkbox"><span class="track"><span class="thumb"></span></span></label><span class="muted">تجريبي</span>
        </div>

        <div class="stack row" style="margin-top:8px">
          <input id="timezone" placeholder="المنطقة" value="auto">
          <input id="startDate" type="date">
          <input id="startTime" type="time">
        </div>

        <div class="btn-col" style="margin-top:10px">
          <button class="btn btn-green" id="startBtn">بدء</button>
          <button class="btn btn-red" id="stopBtn">إيقاف</button>
          <span class="state">التشغيل: <strong id="runState">متوقف</strong></span>
        </div>
      </section>
    </div>
  </main>

  <!-- مودال QR -->
  <div class="overlay" id="qrOverlay">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="head">
        <strong>مسح QR</strong>
        <button id="closeQr" class="btn btn-red">إغلاق</button>
      </div>
      <div class="body">
        <div id="qrBox" style="min-height:300px;display:flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:12px">
          <span class="muted">جارِ جلب QR...</span>
        </div>
        <div class="muted" style="margin-top:8px">واتساب → الأجهزة المرتبطة → ربط جهاز</div>
      </div>
    </div>
  </div>

  <!-- مودال المجموعات -->
  <div class="overlay" id="groupsOverlay">
    <div class="sheet sheet-lg" role="dialog" aria-modal="true">
      <div class="head">
        <strong>المجموعات</strong>
        <div class="row" style="gap:6px">
          <input id="groupSearch" placeholder="بحث..." style="width:46vw;max-width:360px">
          <button class="btn btn-ghost" id="refreshChats">تحديث</button>
          <button class="btn btn-ghost" id="selectAllChats">الكل</button>
          <button class="btn btn-ghost" id="clearAllChats">إلغاء</button>
          <button class="btn btn-red" id="closeGroupsModal">إغلاق</button>
        </div>
      </div>
      <div class="body" id="chatsList" style="max-height:56vh;overflow:auto"></div>
      <div class="foot">
        <span class="muted">المحدد: <strong id="selectedCount">0</strong></span>
        <button class="btn" id="saveSelectedGroups">حفظ</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>

<script>
/* ===== إعدادات افتراضية (بدون إدخال يدوي) ===== */
const DEFAULT_API_BASE = 'https://whatsapp-bot-backend-1jdi.onrender.com';
const DEFAULT_API_KEY  = 'ahmad_SUPER_secret_2025'; // ⚠️ لأجل السرعة فقط. لاحقًا نبدلها بآلية آمنة.

/* ===== Helpers & Storage ===== */
const LS={api:'bot_api_v1',groupsNames:'bot_groups_names_v1',clients:'bot_clients_v1',settings:'bot_settings_v1',theme:'bot_theme_v1'};
const $=id=>document.getElementById(id);
const toast=(m,t='ok')=>{const x=$('toast');x.className='';x.classList.add(t==='ok'?'ok':'err');x.textContent=m;x.style.display='block';setTimeout(()=>x.style.display='none',2200)};
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const load=(k,d)=>{try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(d))}catch{return d}};
const esc=s=>(s||'').replace(/[&<>'"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[m]));

/* ===== Theme ===== */
(function(){
  const t=load(LS.theme,{dark:null}); const prefersDark=window.matchMedia('(prefers-color-scheme: dark)').matches;
  if(t.dark===true || (t.dark===null && prefersDark)) document.body.classList.add('dark');
  $('darkToggle').checked=document.body.classList.contains('dark');
  $('darkToggle').addEventListener('change',()=>{document.body.classList.toggle('dark',$('darkToggle').checked); save(LS.theme,{dark:$('darkToggle').checked});});
})();

/* ===== API Context (مخفي) ===== */
const API = {
  get base(){ return (load(LS.api,{base:DEFAULT_API_BASE,key:DEFAULT_API_KEY}).base||DEFAULT_API_BASE).replace(/\/$/,'') },
  get key (){ return (load(LS.api,{base:DEFAULT_API_BASE,key:DEFAULT_API_KEY}).key || DEFAULT_API_KEY) },
  setCtx(b,k){ save(LS.api,{base:b||DEFAULT_API_BASE,key:k||DEFAULT_API_KEY}); }
};
// خزّن الافتراضيات مرة إن لم تكن موجودة
(function(){ const cur=load(LS.api,null); if(!cur){ save(LS.api,{base:DEFAULT_API_BASE,key:DEFAULT_API_KEY}); } })();

/* ===== عناصر ===== */
const els={
  connectBtn:$('connectBtn'),status:$('status'),statusChip:$('statusChip'),
  pickGroups:$('pickGroups'),refreshGroups:$('refreshGroups'),groupsTags:$('groupsTags'),
  bulkClients:$('bulkClients'),applyClients:$('applyClients'),clearClients:$('clearClients'),
  sheetUrl:$('sheetUrl'),importSheet:$('importSheet'),
  mode:$('mode'),emoji:$('emoji'),replyText:$('replyText'),
  threshold:$('threshold'),cooldown:$('cooldown'),rateLimit:$('rateLimit'),
  mustInclude:$('mustInclude'),mustExclude:$('mustExclude'),
  normalizeArabic:$('normalizeArabic'),enableOCR:$('enableOCR'),instantEyes:$('instantEyes'),dryRun:$('dryRun'),
  timezone:$('timezone'),startDate:$('startDate'),startTime:$('startTime'),
  startBtn:$('startBtn'),stopBtn:$('stopBtn'),runState:$('runState'),
  qrOverlay:$('qrOverlay'),closeQr:$('closeQr'),qrBox:$('qrBox'),
  groupsOverlay:$('groupsOverlay'),closeGroupsModal:$('closeGroupsModal'),
  groupSearch:$('groupSearch'),chatsList:$('chatsList'),refreshChats:$('refreshChats'),
  selectAllChats:$('selectAllChats'),clearAllChats:$('clearAllChats'),saveSelectedGroups:$('saveSelectedGroups'),selectedCount:$('selectedCount'),
};

/* ===== Session/Health ===== */
function setSessionUI(ok){ const s=ok?'متصل':'غير متصل'; els.status.textContent=s; els.statusChip.textContent=s; }
async function health(){
  try{const r=await fetch(API.base+'/health',{headers:{Authorization:'Bearer '+API.key}}); if(!r.ok) return {ok:false}; const d=await r.json(); return {ok:true,ready:!!d.isReady};}
  catch{return {ok:false}}
}
let watchTimer=null;
async function startWatcher(){
  if(watchTimer) clearInterval(watchTimer);
  const tick=async()=>{ const h=await health(); setSessionUI(h.ok && h.ready); };
  await tick(); watchTimer=setInterval(tick,5000);
}
startWatcher();

/* ===== Mode toggle (emoji/text) ===== */
(function(){ const sync=()=>{els.emoji.style.display=els.mode.value==='emoji'?'block':'none'; els.replyText.style.display=els.mode.value==='text'?'block':'none'}; els.mode.addEventListener('change',sync); sync(); })();

/* ===== QR flow ===== */
function openQR(){ els.qrOverlay.style.display='flex' } function closeQR(){ els.qrOverlay.style.display='none' }
els.closeQr.addEventListener('click',closeQR);
async function fetchQR(){
  try{const r=await fetch(API.base+'/session/qr',{headers:{Authorization:'Bearer '+API.key}});
    if(r.ok){const d=await r.json(); if(d.qr){els.qrBox.innerHTML=`<img src="${d.qr}" style="width:100%;max-width:320px;display:block">`; return 'qr'}
      if(d.message==='Already connected') return 'connected'}
  }catch{}
  els.qrBox.innerHTML='<span class="muted">لا يوجد QR… سيُعاد</span>'; return 'waiting';
}
async function checkReady(){ const h=await health(); return h.ok && h.ready; }
els.connectBtn.addEventListener('click',async()=>{
  openQR(); let first=await fetchQR();
  if(first==='connected'){ els.qrBox.innerHTML='<span class="muted">متصل ✅</span>'; setSessionUI(true); setTimeout(closeQR,900); return }
  const poll=setInterval(async()=>{ if(await checkReady()){ els.qrBox.innerHTML='<span class="muted">تم ✅</span>'; setSessionUI(true); clearInterval(poll); setTimeout(closeQR,800) } else { await fetchQR() } },3000);
});

/* ===== Groups ===== */
let allChats=[], selectedIds=[], selectedNames=load(LS.groupsNames,[]);
function renderTags(){ els.groupsTags.innerHTML=''; selectedNames.forEach(n=>{const t=document.createElement('div');t.className='tag';t.textContent=n;els.groupsTags.appendChild(t)}); }
renderTags();
function openGroups(){ els.groupsOverlay.style.display='flex' } function closeGroups(){ els.groupsOverlay.style.display='none' }
els.closeGroupsModal.addEventListener('click',closeGroups);
function renderList(){
  const q=(els.groupSearch.value||'').toLowerCase(); const list=allChats.filter(c=>(c.name||'').toLowerCase().includes(q));
  els.chatsList.innerHTML='';
  list.forEach(c=>{
    const row=document.createElement('div'); row.className='row'; row.style.cssText='justify-content:space-between;border-bottom:1px solid var(--border);padding:8px 4px';
    const checked=selectedIds.includes(c.id)?'checked':''; row.innerHTML=`<label class="row" style="gap:10px"><input type="checkbox" data-id="${c.id}" ${checked}><span>${esc(c.name||'')}</span></label><span class="muted">${c.participants||0} عضو</span>`;
    els.chatsList.appendChild(row);
  });
  els.selectedCount.textContent=String(selectedIds.length);
  els.chatsList.querySelectorAll('input[type="checkbox"]').forEach(ch=>{
    ch.addEventListener('change',e=>{
      const id=e.target.getAttribute('data-id');
      if(e.target.checked){ if(!selectedIds.includes(id)) selectedIds.push(id) }
      else{ selectedIds=selectedIds.filter(x=>x!==id) }
      els.selectedCount.textContent=String(selectedIds.length);
    });
  });
}
async function loadChats(){
  els.chatsList.innerHTML='<div class="muted" style="padding:8px">...تحميل</div>';
  try{const r=await fetch(API.base+'/chats',{headers:{Authorization:'Bearer '+API.key}}); if(!r.ok) throw new Error('HTTP '+r.status);
    const data=await r.json(); allChats=(Array.isArray(data)?data:[]).filter(c=>c&&c.isGroup!==false);
    const set=new Set(selectedNames); selectedIds=allChats.filter(c=>set.has(c.name)).map(c=>c.id); renderList();
  }catch(e){ els.chatsList.innerHTML=`<div class="muted" style="padding:8px">تعذّر: ${e.message}</div>` }
}
els.pickGroups.addEventListener('click',async()=>{await loadChats(); openGroups()});
els.refreshGroups.addEventListener('click',async()=>{await loadChats(); openGroups()});
els.refreshChats.addEventListener('click',loadChats);
els.groupSearch.addEventListener('input',renderList);
els.selectAllChats.addEventListener('click',()=>{selectedIds=allChats.map(c=>c.id); renderList()});
els.clearAllChats.addEventListener('click',()=>{selectedIds=[]; renderList()});
els.saveSelectedGroups.addEventListener('click',async()=>{
  const set=new Set(selectedIds); selectedNames=allChats.filter(c=>set.has(c.id)).map(c=>c.name); save(LS.groupsNames,selectedNames); renderTags();
  try{await fetch(API.base+'/groups/select',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+API.key},body:JSON.stringify({ids:selectedIds})}); toast('تم الحفظ ✅','ok')}
  catch{toast('حُفظ محليًا','err')} closeGroups();
});

/* ===== Clients ===== */
function parseClients(text){
  const lines=(text||'').split(/\n+/).map(s=>s.trim()).filter(Boolean); const out=[]; const seen=new Set();
  for(const l of lines){ let name=l,emoji=''; if(l.includes(',')){const [n,e]=l.split(','); name=(n||'').trim(); emoji=(e||'').trim()}
    const key=name.replace(/\s+/g,' ').trim(); if(!key||seen.has(key)) continue; seen.add(key); out.push({name:key,emoji}) }
  return out;
}
els.applyClients.addEventListener('click',()=>{const list=parseClients(els.bulkClients.value); save(LS.clients,list); toast(`حُفظ ${list.length} عميل ✅`,'ok')});
els.clearClients.addEventListener('click',()=>{els.bulkClients.value=''; save(LS.clients,[]); toast('تم المسح','ok')});
els.importSheet.addEventListener('click',async()=>{const url=(els.sheetUrl.value||'').trim(); if(!url) return toast('ضع رابط CSV','err'); try{const r=await fetch(url); const t=await r.text(); const lines=t.split(/\r?\n/).filter(x=>x.trim()); els.bulkClients.value=lines.join('\n'); toast('CSV جاهز — احفظ','ok')}catch{toast('تعذّر CSV','err')}});

/* ===== Settings + Start/Stop ===== */
function persistSettings(){
  const s={mode:els.mode.value,emoji:els.emoji.value,replyText:els.replyText.value,threshold:+els.threshold.value||60,cooldown:+els.cooldown.value||3,rateLimit:+els.rateLimit.value||20,mustInclude:els.mustInclude.value,mustExclude:els.mustExclude.value,normalizeArabic:els.normalizeArabic.checked,enableOCR:els.enableOCR.checked,instantEyes:els.instantEyes.checked,dryRun:els.dryRun.checked,timezone:els.timezone.value,startDate:els.startDate.value,startTime:els.startTime.value};
  save(LS.settings,s);
}
(function preloadSettings(){
  const s=load(LS.settings,{}); const V=(k,d)=>{if(s[k]!==undefined&&els[k]) els[k].value=s[k]; else if(d!==undefined&&els[k]) els[k].value=d};
  const C=(k,d)=>{if(s[k]!==undefined&&els[k]) els[k].checked=!!s[k]; else if(d!==undefined&&els[k]) els[k].checked=!!d};
  V('mode','emoji'); V('emoji','✅'); V('replyText','تم ✅'); V('threshold',60); V('cooldown',3); V('rateLimit',20);
  V('mustInclude',''); V('mustExclude',''); C('normalizeArabic',true); C('enableOCR',false); C('instantEyes',true); C('dryRun',false);
  V('timezone','auto'); V('startDate',''); V('startTime','');
  const cl=load(LS.clients,[]); if(cl.length) els.bulkClients.value=cl.map(c=>c.emoji?`${c.name},${c.emoji}`:c.name).join('\n');
  const sync=()=>{els.emoji.style.display=els.mode.value==='emoji'?'block':'none'; els.replyText.style.display=els.mode.value==='text'?'block':'none'}; sync(); els.mode.addEventListener('change',sync);
})();
['mode','emoji','replyText','threshold','cooldown','rateLimit','mustInclude','mustExclude','timezone','startDate','startTime'].forEach(id=>els[id]?.addEventListener('change',persistSettings));
['normalizeArabic','enableOCR','instantEyes','dryRun'].forEach(id=>els[id]?.addEventListener('change',persistSettings));

async function postJSON(path,body){
  const r=await fetch(API.base+path,{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+API.key},body:JSON.stringify(body||{})});
  if(!r.ok) throw new Error('HTTP '+r.status); return r.json();
}
function packPayload(){ return {clients:load(LS.clients,[]), groups:load(LS.groupsNames,[]), settings:load(LS.settings,{})} }

els.startBtn.addEventListener('click',async()=>{ try{persistSettings(); await postJSON('/bot/start',packPayload()); els.runState.textContent='شغّال'; toast('بدأ ✅','ok')}catch(e){toast('تعذّر البدء: '+e.message,'err')} });
els.stopBtn .addEventListener('click',async()=>{ try{await postJSON('/bot/stop',{}); els.runState.textContent='متوقف'; toast('توقّف','ok')}catch(e){toast('تعذّر الإيقاف: '+e.message,'err')} });
</script>
</body>
</html>
