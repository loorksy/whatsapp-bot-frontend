<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø¨ÙˆØª ÙˆØ§ØªØ³Ø§Ø¨</title>
<style>
  :root{
    --bg:#f2f2f7; --card:#fff; --text:#0f172a; --muted:#6b7280; --border:#e5e7eb;
    --blue:#0a84ff; --green:#34c759; --red:#ff3b30; --ghost:#eef2ff; --chip:#f3f4f6;
    --shadow:0 10px 24px rgba(10,10,20,.06);
  }
  .dark{
    --bg:#0b0f14; --card:#0f141a; --text:#e5e7eb; --muted:#94a3b8; --border:#1f2937;
    --ghost:#1f2937; --chip:#111827; --shadow:0 12px 30px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Tajawal",Arial,sans-serif}
  header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);padding:12px;display:flex;justify-content:space-between;align-items:center}
  main{max-width:920px;margin:12px auto;padding:0 12px 72px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:var(--shadow);margin:10px 0}
  h3{margin:0 0 8px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input,select,textarea,button{border:1px solid var(--border);border-radius:12px;padding:10px;font-size:15px;background:var(--card);color:var(--text)}
  textarea{min-height:90px;width:100%}
  .btn{background:var(--blue);color:#fff;border:none;font-weight:800;cursor:pointer}
  .btn-ghost{background:var(--ghost)} .btn-green{background:var(--green)} .btn-red{background:var(--red)}
  .state{display:inline-flex;gap:6px;align-items:center;background:var(--chip);padding:6px 10px;border-radius:999px}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:60}
  .sheet{background:var(--card);width:min(95vw,780px);max-height:86vh;border-radius:16px;overflow:auto;border:1px solid var(--border);box-shadow:var(--shadow)}
  .head{padding:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
  .body{padding:12px} .foot{padding:12px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:space-between}
  #toast{position:fixed;bottom:16px;left:16px;right:16px;margin:auto;max-width:420px;background:#111827;color:#fff;padding:10px;border-radius:12px;display:none;z-index:99}
</style>
</head>
<body>
<header>
  <strong>Ø¨ÙˆØª ÙˆØ§ØªØ³Ø§Ø¨</strong>
  <div class="row">
    <span class="state">Ø¬Ù„Ø³Ø©: <b id="sessionState">ØºÙŠØ± Ù…ØªØµÙ„</b></span>
    <label class="row" style="gap:6px"><input type="checkbox" id="darkToggle"> ğŸŒ™</label>
  </div>
</header>

<main>
  <!-- Ø§Ù„Ø¬Ù„Ø³Ø© -->
  <section class="card">
    <h3>ğŸ”Œ Ø§Ù„Ø¬Ù„Ø³Ø©</h3>
    <div class="row">
      <button class="btn" id="btnQR">Ø±Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨ (QR)</button>
      <button class="btn btn-ghost" id="btnGroups">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</button>
      <button class="btn btn-ghost" id="btnGroupsRefresh">ØªØ­Ø¯ÙŠØ«</button>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="state">Ø§Ù„Ø­Ø§Ù„Ø©: <b id="sessionChip">ØºÙŠØ± Ù…ØªØµÙ„</b></span>
      <span class="state">Ø§Ù„Ù…Ø­Ø¯Ø¯: <b id="groupsCount">0</b></span>
    </div>
    <div id="selectedGroupsTags" style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap"></div>
  </section>

  <!-- Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
  <section class="card">
    <h3>ğŸ‘¤ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
    <textarea id="clientsText" placeholder="Ø³Ø·Ø± Ù„ÙƒÙ„ Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…,Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ"></textarea>
    <div class="row">
      <button class="btn btn-ghost" id="saveClients">Ø­ÙØ¸</button>
      <button class="btn btn-ghost" id="clearClients">Ù…Ø³Ø­</button>
    </div>
  </section>

  <!-- Ø§Ù„ØªÙØ§Ø¹Ù„ -->
  <section class="card">
    <h3>âš¡ Ø§Ù„ØªÙØ§Ø¹Ù„</h3>
    <div class="row">
      <label>Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ</label>
      <input id="emoji" value="âœ…" style="width:80px">
    </div>
    <div class="row">
      <label>Ø³Ø±Ø¹Ø© Ø§Ù„Ø±Ø¯</label>
      <input id="rateLimit" type="number" min="1" max="120" value="20" style="width:120px" title="Ø¹Ø¯Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø¨Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©">
      <input id="cooldown"  type="number" min="0" max="300" value="3"  style="width:120px" title="Ù…Ù‡Ù„Ø© Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ Ø¨ÙŠÙ† ØªÙØ§Ø¹Ù„ÙŠÙ†">
    </div>
    <div class="row" style="margin-top:8px">
      <label class="row" style="gap:6px"><input type="checkbox" id="enableOCR"> ØªØ¯Ù‚ÙŠÙ‚ ØµÙˆØ± (OCR)</label>
      <span class="muted">ÙŠØ­Ù„Ù„ ØµÙˆØ± Ø§Ù„ÙˆØµÙ„ Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø§Ø³Ù…</span>
    </div>
  </section>

  <!-- Ø§Ù„Ø£Ø±Ø´ÙŠÙ -->
  <section class="card">
    <h3>ğŸ—„ï¸ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</h3>
    <div class="row">
      <label class="row" style="gap:6px"><input type="checkbox" id="archiveEnabled"> ØªÙØ¹ÙŠÙ„</label>
    </div>
    <div class="row">
      <input type="date" id="archiveDate">
      <input type="time" id="archiveTime" step="60">
      <input type="number" id="archiveLimit" value="200" min="10" max="1000" style="width:140px" title="Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø©">
      <button class="btn btn-ghost" id="scanNow">ÙØ­Øµ Ø§Ù„Ø¢Ù†</button>
    </div>
  </section>

  <!-- ØªØ´ØºÙŠÙ„ -->
  <section class="card">
    <div class="row">
      <button class="btn btn-green" id="toggleStart">Ø¨Ø¯Ø¡</button>
      <span class="state">Ø§Ù„ØªØ´ØºÙŠÙ„: <b id="runState">Ù…ØªÙˆÙ‚Ù</b></span>
    </div>
  </section>

  <section class="card" style="text-align:center">
    <label class="row" style="justify-content:center;gap:6px">
      <input type="checkbox" id="darkToggleBottom"> ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†
    </label>
  </section>
</main>

<!-- Ù…ÙˆØ¯Ø§Ù„ QR -->
<div class="overlay" id="qrModal">
  <div class="sheet" style="max-width:380px">
    <div class="head"><strong>Ù…Ø³Ø­ QR</strong><button class="btn btn-red" id="closeQR">Ø¥ØºÙ„Ø§Ù‚</button></div>
    <div class="body"><div id="qrBox" style="min-height:300px;display:flex;align-items:center;justify-content:center">...</div></div>
  </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª -->
<div class="overlay" id="groupsModal">
  <div class="sheet">
    <div class="head">
      <strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</strong>
      <div class="row">
        <input id="groupSearch" placeholder="Ø¨Ø­Ø«..." style="width:260px">
        <button class="btn btn-ghost" id="refreshChats">ØªØ­Ø¯ÙŠØ«</button>
        <button class="btn btn-ghost" id="selectAll">Ø§Ù„ÙƒÙ„</button>
        <button class="btn btn-ghost" id="clearAll">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn btn-red" id="closeGroups">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
    <div class="body" id="groupsList"></div>
    <div class="foot">
      <span>Ø§Ù„Ù…Ø­Ø¯Ø¯: <b id="selCount">0</b></span>
      <button class="btn" id="saveGroups">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
/* ===== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© Ù„Ù„Ø§ØªØµØ§Ù„ ===== */
const API_BASE = 'https://whatsapp-bot-backend-1jdi.onrender.com';
const API_KEY  = 'ahmad_SUPER_secret_2025';

/* ===== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ===== */
const $=id=>document.getElementById(id);
const toast=(m)=>{const x=$('toast');x.textContent=m;x.style.display='block';setTimeout(()=>x.style.display='none',1800)}
const auth = { headers:{ Authorization:'Bearer '+API_KEY, 'Content-Type':'application/json' } };
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const load=(k,d)=>{try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(d))}catch{return d}};
const esc=s=>(s||'').replace(/[&<>'"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[m]);

/* ===== ÙˆØ¶Ø¹ Ø¯Ø§ÙƒÙ† ===== */
function setDark(on){ document.body.classList.toggle('dark', !!on); $('darkToggle').checked=!!on; $('darkToggleBottom').checked=!!on; save('ui_dark', on); }
$('darkToggle').onchange=()=>setDark($('darkToggle').checked);
$('darkToggleBottom').onchange=()=>setDark($('darkToggleBottom').checked);
setDark(load('ui_dark', null) ?? window.matchMedia('(prefers-color-scheme: dark)').matches);

/* ===== ØµØ­Ø© Ø§Ù„Ø¬Ù„Ø³Ø© ===== */
async function health(){
  try{
    const r=await fetch(API_BASE+'/health');
    const d=await r.json();
    const ok=r.ok && d.isReady===true;
    $('sessionState').textContent= ok?'Ù…ØªØµÙ„':'ØºÙŠØ± Ù…ØªØµÙ„';
    $('sessionChip').textContent = ok?'Ù…ØªØµÙ„':'ØºÙŠØ± Ù…ØªØµÙ„';
    $('runState').textContent    = d.running ? 'Ø´ØºÙ‘Ø§Ù„' : 'Ù…ØªÙˆÙ‚Ù';
    return d;
  }catch{return { isReady:false, running:false }}
}
setInterval(health, 5000); health();

/* ===== Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ===== */
function parseClients(t){
  return (t||'').split(/\n+/).map(s=>s.trim()).filter(Boolean).map(line=>{
    if(line.includes(',')){ const [name,emoji] = line.split(','); return {name:name.trim(),emoji:(emoji||'').trim()} }
    return { name: line, emoji:'' }
  });
}
$('saveClients').onclick=()=>{ const list=parseClients($('clientsText').value); save('clients',list); toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡') }
$('clearClients').onclick=()=>{ $('clientsText').value=''; save('clients',[]); toast('ØªÙ… Ø§Ù„Ù…Ø³Ø­') }
(function preloadClients(){
  const list=load('clients',[]);
  if(list.length) $('clientsText').value = list.map(c=>c.emoji?`${c.name},${c.emoji}`:c.name).join('\n');
})();

/* ===== QR ===== */
const qrModal=$('qrModal'); $('btnQR').onclick=async()=>{ qrModal.style.display='flex'; await showQR() }
$('closeQR').onclick=()=>{ qrModal.style.display='none' }
async function showQR(){
  $('qrBox').innerHTML='...';
  const r=await fetch(API_BASE+'/session/qr', { headers:{ Authorization:'Bearer '+API_KEY } });
  const d=await r.json();
  if(d.qr) $('qrBox').innerHTML=`<img src="${d.qr}" style="max-width:320px;width:100%">`;
  else $('qrBox').innerHTML = d.message==='Already connected' ? 'Ù…ØªØµÙ„ âœ…' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ QR Ø§Ù„Ø¢Ù†';
}

/* ===== Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ===== */
const groupsModal=$('groupsModal'), groupsList=$('groupsList'), selCount=$('selCount');
let allGroups=[], selectedIds=[], selectedNames=load('groupNames',[]);
function renderSelectedTags(){
  const wrap=$('selectedGroupsTags'); wrap.innerHTML='';
  selectedNames.forEach(n=>{ const tag=document.createElement('span'); tag.textContent=n; tag.style.cssText='background:var(--ghost);padding:4px 10px;border-radius:999px;font-size:13px'; wrap.appendChild(tag) });
  $('groupsCount').textContent=String(selectedNames.length);
}
renderSelectedTags();

async function fetchGroups(){
  groupsList.innerHTML='...';
  const r=await fetch(API_BASE+'/chats', { headers:{ Authorization:'Bearer '+API_KEY } });
  const data=await r.json();
  allGroups = Array.isArray(data) ? data : [];
  // Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡
  const set = new Set(selectedNames);
  selectedIds = allGroups.filter(g=>set.has(g.name)).map(g=>g.id);
  drawGroupList();
}
function drawGroupList(){
  const q=($('groupSearch').value||'').toLowerCase();
  const list=allGroups.filter(g=>(g.name||'').toLowerCase().includes(q));
  groupsList.innerHTML='';
  list.forEach(g=>{
    const row=document.createElement('div');
    row.style.cssText='display:flex;justify-content:space-between;border-bottom:1px solid var(--border);padding:8px';
    const checked = selectedIds.includes(g.id) ? 'checked' : '';
    row.innerHTML = `<label class="row" style="gap:8px"><input type="checkbox" data-id="${g.id}" ${checked}><span>${esc(g.name)}</span></label><span class="muted">${g.participants||0} Ø¹Ø¶Ùˆ</span>`;
    groupsList.appendChild(row);
  });
  groupsList.querySelectorAll('input[type="checkbox"]').forEach(ch=>{
    ch.onchange=(e)=>{ const id=e.target.getAttribute('data-id'); if(e.target.checked){ if(!selectedIds.includes(id)) selectedIds.push(id); } else { selectedIds=selectedIds.filter(x=>x!==id); } selCount.textContent=String(selectedIds.length); };
  });
  selCount.textContent=String(selectedIds.length);
}
$('btnGroups').onclick=async()=>{ await fetchGroups(); groupsModal.style.display='flex' }
$('btnGroupsRefresh').onclick=async()=>{ await fetchGroups(); groupsModal.style.display='flex' }
$('refreshChats').onclick=fetchGroups;
$('closeGroups').onclick=()=>{ groupsModal.style.display='none' }
$('selectAll').onclick=()=>{ selectedIds=allGroups.map(g=>g.id); drawGroupList() }
$('clearAll').onclick=()=>{ selectedIds=[]; drawGroupList() }
$('saveGroups').onclick=async()=>{
  const set=new Set(selectedIds);
  selectedNames = allGroups.filter(g=>set.has(g.id)).map(g=>g.name);
  save('groupNames',selectedNames);
  renderSelectedTags();
  await fetch(API_BASE+'/groups/select', { method:'POST', headers:{ Authorization:'Bearer '+API_KEY, 'Content-Type':'application/json' }, body: JSON.stringify({ ids: selectedIds }) });
  toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª');
  groupsModal.style.display='none';
};

/* ===== Ø¨Ø¯Ø¡ / Ø¥ÙŠÙ‚Ø§Ù ===== */
function formSettings(){
  const clients = load('clients',[]);
  const emoji = $('emoji').value || 'âœ…';
  const rateLimit = Math.max(1, +$('rateLimit').value || 20);
  const cooldown  = Math.max(0, +$('cooldown').value  || 3);
  const enableOCR = !!$('enableOCR').checked;
  const archiveEnabled = !!$('archiveEnabled').checked;
  const date = $('archiveDate').value;
  const time = $('archiveTime').value;
  let archiveStart = null;
  if (archiveEnabled && date && time) archiveStart = new Date(`${date}T${time}:00`).toISOString();
  const archiveLimit = Math.max(10, +$('archiveLimit').value || 200);
  return {
    clients,
    settings: {
      emoji, rateLimit, cooldown, enableOCR,
      archive: { enabled: archiveEnabled, startAt: archiveStart, limit: archiveLimit }
    }
  };
}
const toggleBtn=$('toggleStart');
toggleBtn.onclick=async()=>{
  const h = await health();
  if (h.running){
    await fetch(API_BASE+'/bot/stop', { method:'POST', ...auth });
    $('runState').textContent='Ù…ØªÙˆÙ‚Ù'; toggleBtn.textContent='Ø¨Ø¯Ø¡'; toast('ØªÙˆÙ‚Ù');
  }else{
    const body = formSettings();
    await fetch(API_BASE+'/bot/start', { method:'POST', ...auth, body: JSON.stringify(body) });
    $('runState').textContent='Ø´ØºÙ‘Ø§Ù„'; toggleBtn.textContent='Ø¥ÙŠÙ‚Ø§Ù'; toast('Ø¨Ø¯Ø£');
  }
};
$('scanNow').onclick=async()=>{
  const enabled = $('archiveEnabled').checked;
  const date = $('archiveDate').value, time=$('archiveTime').value;
  if (!enabled || !date || !time) return toast('ÙØ¹Ù‘Ù„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙˆØ­Ø¯Ø¯ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª');
  const startAt = new Date(`${date}T${time}:00`).toISOString();
  const limit   = Math.max(10, +$('archiveLimit').value || 200);
  const r=await fetch(API_BASE+'/history/scan', { method:'POST', ...auth, body: JSON.stringify({ startAt, limit }) });
  const d=await r.json(); if(r.ok) toast(`Ø£ÙØ¯Ø±Ø¬ ${d.enqueued||0} Ø±Ø³Ø§Ù„Ø©`); else toast('Ø®Ø·Ø£: '+(d.error||r.statusText));
};
</script>
</body>
</html>
