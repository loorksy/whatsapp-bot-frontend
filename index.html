<!doctype html>

<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø¨ÙˆØª ÙˆØ§ØªØ³Ø§Ø¨ â€“ iOS Style</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, "Noto Sans Arabic", "Tajawal", Arial, sans-serif; background: #f5f6f8; margin: 0; padding: 0; color: #111827; }
  .container { max-width: 960px; margin: 0 auto; padding: 20px; }
  h1 { font-size: 22px; font-weight: 700; margin-bottom: 20px; text-align: center; }
  h2 { font-size: 16px; font-weight: 800; margin: 0 0 10px; }
  .card { background: #fff; border-radius: 18px; box-shadow: 0 4px 14px rgba(0,0,0,0.08); margin-bottom: 20px; padding: 16px; }
  .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  .stack { display: flex; flex-direction: column; gap: 10px; }
  .input, .select { flex: 1; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 12px; font-size: 14px; }
  .textarea { width: 100%; min-height: 120px; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 12px; font-size: 14px; resize: vertical; }
  .btn { padding: 10px 14px; border: 0; border-radius: 12px; font-weight: 600; cursor: pointer; }
  .btn-blue { background: #0a84ff; color: #fff; }
  .btn-green { background: #34c759; color: #fff; }
  .btn-red { background: #ff3b30; color: #fff; }
  .btn-ghost { background:#eef2ff; color:#1e293b; }
  .client { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #f1f5f9; }
  .muted { color: #6b7280; font-size: 13px; }
  .switch { position: relative; width: 48px; height: 28px; background: #e5e7eb; border-radius: 999px; cursor: pointer; }
  .switch input { display: none; }
  .switch .dot { position: absolute; top: 3px; right: 3px; width: 22px; height: 22px; background: #fff; border-radius: 50%; transition: .2s; }
  .switch input:checked + .dot { right: 23px; background: #34c759; }
  .tags{display:flex;flex-wrap:wrap;gap:8px}
  .tag{display:flex;align-items:center;gap:6px;background:#eef2ff;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:13px}
  .tag button{background:transparent;border:0;color:#ef4444;cursor:pointer}
  .line{height:1px;background:#f1f5f9;margin:12px 0}
  .pill{display:inline-block;background:#f3f4f6;border-radius:999px;padding:4px 10px;font-size:12px;color:#111827;margin:2px}
</style>
</head>
<body>
  <div class="container">
    <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¨ÙˆØª</h1><!-- Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„ØªØ­ÙƒÙ… -->
<div class="card">
  <h2>Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„ØªØ­ÙƒÙ…</h2>
  <div class="row">
    <button class="btn btn-blue" id="connectBtn">ğŸ”— Ø±Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨</button>
    <button class="btn btn-green" id="startBtn">â–¶ï¸ Ø¨Ø¯Ø¡</button>
    <button class="btn btn-red" id="stopBtn" disabled>â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù</button>
    <span class="muted">Ø§Ù„Ø­Ø§Ù„Ø©: <strong id="status">ØºÙŠØ± Ù…ØªØµÙ„</strong></span>
  </div>
  <div class="line"></div>
  <div class="stack">
    <label class="muted">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„ØªÙŠ ÙŠØ±Ø§Ù‚Ø¨Ù‡Ø§ Ø§Ù„Ø¨ÙˆØª</label>
    <div class="row">
      <input id="groupInput" class="input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø¶Ø§ÙØ©" />
      <button class="btn btn-ghost" id="addGroup">Ø¥Ø¶Ø§ÙØ© Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
    </div>
    <div class="tags" id="groupsTags"></div>
  </div>
  <div class="line"></div>
  <div class="stack">
    <label class="muted">Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</label>
    <div class="row">
      <label><input type="checkbox" id="logMessages"> ØªØ³Ø¬ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Logs)</label>
      <label><input type="checkbox" id="notifyOnMatch"> Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªØ·Ø§Ø¨Ù‚</label>
      <label><input type="checkbox" id="allowImages"> ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ± (OCR)</label>
    </div>
  </div>
</div>

<!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ -->
<div class="card">
  <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„</h2>
  <div class="stack">
    <label>ÙˆØ¶Ø¹ Ø§Ù„ØªÙØ§Ø¹Ù„</label>
    <select id="mode" class="select">
      <option value="reaction">ØªÙØ§Ø¹Ù„ Ø¨Ø¥ÙŠÙ…ÙˆØ¬ÙŠ</option>
      <option value="reply">Ø±Ø¯ Ù†ØµÙŠ</option>
    </select>
    <input id="emoji" class="input" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ (âœ…)" />
    <input id="replyText" class="input" placeholder="Ø§Ù„Ù†Øµ Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø¯ (ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯ âœ…)" />
    <div class="row">
      <div class="stack" style="flex:1">
        <label class="muted">Ø¨Ø¯Ø¡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
        <input id="startDate" type="date" class="input" />
      </div>
      <div class="stack" style="width:200px">
        <label class="muted">Ø§Ù„Ø³Ø§Ø¹Ø©</label>
        <input id="startTime" type="time" class="input" />
      </div>
    </div>
    <div class="row">
      <div class="stack" style="flex:1">
        <label class="muted">Ø­Ø¯Ù‘ Ø§Ù„ØªØ·Ø§Ø¨Ù‚ (%)</label>
        <input id="threshold" type="number" class="input" min="40" max="95" step="1" placeholder="60" />
      </div>
      <div class="stack" style="flex:1">
        <label class="muted">Ø¥Ø¬Ø±Ø§Ø¡ Ø¹Ù†Ø¯ Ø¹Ø¯Ù… Ø§Ù„ØªØ·Ø§Ø¨Ù‚</label>
        <select id="fallback" class="select">
          <option value="ignore">ØªØ¬Ø§Ù‡Ù„</option>
          <option value="flag">ØªØ£Ø´ÙŠØ± Ù„Ù„ØªØ¯Ù‚ÙŠÙ‚</option>
          <option value="auto-reply">Ø±Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ø§Ù…</option>
        </select>
      </div>
    </div>
  </div>
</div>

<!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
<div class="card">
  <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
  <div class="row">
    <input id="clientName" class="input" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ" />
    <input id="clientEmoji" class="input" placeholder="Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ù…Ø®ØµØµ" />
    <button class="btn btn-blue" id="addClient">Ø¥Ø¶Ø§ÙØ©</button>
  </div>
  <div class="line"></div>
  <div class="stack">
    <label><strong>Ù„ØµÙ‚ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©</strong></label>
    <textarea id="bulkTextarea" class="textarea" placeholder="Ù…Ø«Ø§Ù„:\nØ£Ø­Ù…Ø¯ Ø¹ÙŠØ³Ù‰ Ù…Ø­Ù…Ø¯\nÙ…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ Ø£Ø­Ù…Ø¯,âœ…\nÙ„ÙŠÙ„Ù‰ Ø®Ø§Ù„Ø¯ Ø­Ø³Ù†,ğŸ”¥"></textarea>
    <div class="row">
      <button class="btn btn-blue" id="bulkAddBtn">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø©</button>
      <button class="btn btn-red" id="clearClients">Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
    </div>
  </div>
  <div class="line"></div>
  <div class="stack">
    <label><strong>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Google Sheets (CSV)</strong></label>
    <div class="row">
      <input id="sheetUrl" class="input" placeholder="Ø±Ø§Ø¨Ø· CSV Ø§Ù„Ù…Ù†Ø´ÙˆØ±" />
      <button class="btn btn-blue" id="importSheet">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
    </div>
  </div>
  <div class="line"></div>
  <div id="clientsList"></div>
</div>

<!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
<div class="card">
  <h2>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
  <div class="row">
    <div class="pill">ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: <span id="statClients">0</span></div>
    <div class="pill">ğŸ’¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: <span id="statMessages">0</span></div>
    <div class="pill">âœ… Ø§Ù„ØªØ·Ø§Ø¨Ù‚Ø§Øª: <span id="statMatches">0</span></div>
  </div>
</div>

<!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ù„ØªÙØ§Ø¹Ù„ -->
<div class="card">
  <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ù„ØªÙØ§Ø¹Ù„</h2>
  <div class="stack">
    <div class="row">
      <div class="stack" style="width:180px">
        <label class="muted">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ·Ø§Ø¨Ù‚ (%)</label>
        <input id="threshold" type="number" class="input" min="40" max="95" step="1" placeholder="60" />
      </div>
      <div class="stack" style="width:200px">
        <label class="muted">Ù…Ù‡Ù„Ø© Ø¨ÙŠÙ† Ø±Ø¯Ù‘ÙŠÙ† (Ø«)</label>
        <input id="cooldown" type="number" class="input" min="0" max="300" step="1" placeholder="3" />
      </div>
      <div class="stack" style="width:240px">
        <label class="muted">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØªÙØ§Ø¹Ù„Ø§Øª/Ø¯Ù‚ÙŠÙ‚Ø©</label>
        <input id="rateLimit" type="number" class="input" min="1" max="120" step="1" placeholder="20" />
      </div>
    </div>
    <div class="row">
      <div class="stack" style="flex:1">
        <label class="muted">ÙƒÙ„Ù…Ø§Øª ÙŠØ¬Ø¨ ÙˆØ¬ÙˆØ¯Ù‡Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input id="mustInclude" class="input" placeholder="Ù…Ø«Ø§Ù„: ÙˆØµÙ„, Ø§Ø³ØªÙ„Ø§Ù…, Ø­ÙˆØ§Ù„Ø©" />
      </div>
      <div class="stack" style="flex:1">
        <label class="muted">ÙƒÙ„Ù…Ø§Øª ØªÙ…Ù†Ø¹ Ø§Ù„ØªÙØ§Ø¹Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input id="mustExclude" class="input" placeholder="Ù…Ø«Ø§Ù„: ØªØ¬Ø±Ø¨Ø©, ØªØ¬Ø±ÙŠØ¨ÙŠ, Ù…Ø²Ø§Ø­" />
      </div>
    </div>
    <div class="row">
      <label class="row" style="gap:6px"><input type="checkbox" id="normalizeArabic" checked> ØªØ·Ø¨ÙŠØ¹/Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ´ÙƒÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¨ÙŠ</label>
      <label class="row" style="gap:6px"><input type="checkbox" id="instantEyes" checked> ğŸ‘€ Ø±Ø¯ ÙÙˆØ±ÙŠ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ± Ø«Ù… âœ… Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚</label>
      <label class="row" style="gap:6px"><input type="checkbox" id="enableOCR" checked> ØªÙØ¹ÙŠÙ„ OCR Ù„Ù„ØµÙˆØ±</label>
    </div>
  </div>
</div>

<!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§Ø¯Ù… (Ù…ØªÙ‚Ø¯Ù…) -->
<div class="card">
  <div class="row" style="justify-content:space-between;align-items:center">
    <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§Ø¯Ù… (Ù…ØªÙ‚Ø¯Ù…)</h2>
    <span class="muted">Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¨Ø§Ùƒ-Ø¥Ù†Ø¯ Ø§Ù„Ø¨ÙˆØª</span>
  </div>
  <div class="row">
    <input id="apiBase" class="input" placeholder="API Base URL (Ù…Ø«Ø§Ù„: https://bot.example.com)" />
    <input id="apiKey" class="input" placeholder="API Key / Token" />
  </div>
  <div class="row" style="margin-top:8px">
    <button class="btn btn-ghost" id="exportSettings">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    <label class="btn btn-ghost" for="importSettings">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</label>
    <input id="importSettings" type="file" accept="application/json" style="display:none" />
    <button class="btn btn-blue" id="pingServer">ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„</button>
    <span class="muted" id="pingResult">â€”</span>
  </div>
  <p class="hint">Ø§Ù„ØªØµØ¯ÙŠØ±/Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙŠØ´Ù…Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙÙ‚Ø· (Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙŠÙØ¯Ø§Ø±ÙˆÙ† Ù…Ù† Ø§Ù„Ù‚Ø³Ù… Ø£Ø¹Ù„Ø§Ù‡).</p>
</div>

  </div><script>
  const $ = s => document.querySelector(s);
  const els = {
    status: document.getElementById('status'), startBtn: document.getElementById('startBtn'), stopBtn: document.getElementById('stopBtn'),
    connectBtn: document.getElementById('connectBtn'),
    mode: document.getElementById('mode'), emoji: document.getElementById('emoji'), replyText: document.getElementById('replyText'), startDate: document.getElementById('startDate'), startTime: document.getElementById('startTime'),
    groupInput: document.getElementById('groupInput'), addGroup: document.getElementById('addGroup'), groupsTags: document.getElementById('groupsTags'), pickFromWhatsApp: document.getElementById('pickFromWhatsApp'),
    clientName: document.getElementById('clientName'), clientEmoji: document.getElementById('clientEmoji'), addClient: document.getElementById('addClient'),
    bulkTextarea: document.getElementById('bulkTextarea'), bulkAddBtn: document.getElementById('bulkAddBtn'), clearClients: document.getElementById('clearClients'),
    sheetUrl: document.getElementById('sheetUrl'), importSheet: document.getElementById('importSheet'),
    clientsList: document.getElementById('clientsList'),
    threshold: document.getElementById('threshold'), cooldown: document.getElementById('cooldown'), rateLimit: document.getElementById('rateLimit'),
    mustInclude: document.getElementById('mustInclude'), mustExclude: document.getElementById('mustExclude'),
    normalizeArabic: document.getElementById('normalizeArabic'), enableOCR: document.getElementById('enableOCR'), instantEyes: document.getElementById('instantEyes'),
    timezone: document.getElementById('timezone'),
    apiBase: document.getElementById('apiBase'), apiKey: document.getElementById('apiKey'), pingServer: document.getElementById('pingServer'), pingResult: document.getElementById('pingResult'),
    exportSettings: document.getElementById('exportSettings'), importSettings: document.getElementById('importSettings'),
    groupsOverlay: document.getElementById('groupsOverlay'), closeGroupsModal: document.getElementById('closeGroupsModal'),
    groupSearch: document.getElementById('groupSearch'), chatsList: document.getElementById('chatsList'), chatsHint: document.getElementById('chatsHint'),
    refreshChats: document.getElementById('refreshChats'), selectAllChats: document.getElementById('selectAllChats'), clearAllChats: document.getElementById('clearAllChats'),
    saveSelectedGroups: document.getElementById('saveSelectedGroups'), selectedCount: document.getElementById('selectedCount')
  };

  let clients = [];
  let groups = [];
  let stats = { messages:0, matches:0 };

  function renderClients(){
    els.clientsList.innerHTML = '';
    els.statClients.textContent = clients.length;
    if(clients.length===0){ els.clientsList.innerHTML = '<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¹Ø¯</div>'; return; }
    clients.forEach((c,i)=>{
      const div = document.createElement('div');
      div.className = 'client';
      div.innerHTML = `<div><strong>${c.name}</strong><div class='muted'>Ø±Ø¯: ${c.emoji||'âœ…'}</div></div>
      <button class='btn btn-red' onclick='removeClient(${i})'>Ø­Ø°Ù</button>`;
      els.clientsList.appendChild(div);
    });
  }
  function removeClient(i){ clients.splice(i,1); renderClients(); }

  els.addClient.onclick = ()=>{
    const name = els.clientName.value.trim(); if(!name) return;
    const emoji = els.clientEmoji.value.trim() || 'âœ…';
    clients.push({ name, emoji, active:true });
    els.clientName.value=''; els.clientEmoji.value='';
    renderClients();
  };

  els.bulkAddBtn.onclick = ()=>{
    const raw = els.bulkTextarea.value.trim(); if(!raw) return;
    raw.split(/\r?\n/).forEach(line=>{
      const parts = line.split(',');
      const name = (parts[0]||'').trim();
      if(!name) return;
      const emoji = (parts[1]||'').trim()||'âœ…';
      clients.push({ name, emoji, active:true });
    });
    els.bulkTextarea.value='';
    renderClients();
  };

  els.clearClients.onclick = ()=>{ if(confirm('Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ØŸ')){ clients=[]; renderClients(); } };

  els.addGroup.onclick = ()=>{
    const g = els.groupInput.value.trim(); if(!g) return;
    if(!groups.includes(g)) groups.push(g);
    renderGroups(); els.groupInput.value='';
  };
  function renderGroups(){
    els.groupsTags.innerHTML = '';
    groups.forEach((g,i)=>{
      const tag = document.createElement('div');
      tag.className='tag';
      tag.innerHTML = g+` <button onclick='removeGroup(${i})'>Ã—</button>`;
      els.groupsTags.appendChild(tag);
    });
  }
  function removeGroup(i){ groups.splice(i,1); renderGroups(); }

  els.importSheet.onclick = async()=>{
    const url = els.sheetUrl.value.trim(); if(!url) return;
    try{
      const res = await fetch(url); const text = await res.text();
      text.split(/\r?\n/).forEach(line=>{
        const cols=line.split(',');
        const name=(cols[0]||'').trim(); if(!name||/^(name)$/i.test(name)) return;
        const emoji=(cols[1]||'').trim()||'âœ…';
        clients.push({ name, emoji, active:true });
      });
      renderClients(); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ…');
    }catch(e){ alert('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯'); }
  };

  // ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù (ØªØ¬Ø±ÙŠØ¨ÙŠ)
  els.startBtn.onclick = ()=>{ els.status.textContent='Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„'; els.startBtn.disabled=true; els.stopBtn.disabled=false; };
  els.stopBtn.onclick = ()=>{ els.status.textContent='Ù…ØªÙˆÙ‚Ù'; els.startBtn.disabled=false; els.stopBtn.disabled=true; };

  renderClients();
  renderGroups();
// ======== ØªÙƒÙ…Ù„Ø©: Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© ÙˆØ¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø®Ø§Ø¯Ù… ========
(function(){
  const LS_SETTINGS='bot_settings_v1';
  const LS_GROUPS='bot_groups_v1';
  function get(id){return document.getElementById(id)}
  function read(){try{return JSON.parse(localStorage.getItem(LS_SETTINGS)||'{}')}catch{return {}}}
  function write(o){localStorage.setItem(LS_SETTINGS, JSON.stringify(o))}
  function setVal(id,v){const e=get(id); if(e&&v!==undefined) e.value=v}
  function setChk(id,v){const e=get(id); if(e) e.checked=!!v}
  function val(id,def){const e=get(id); return e?(e.value||def):def}
  function chk(id){const e=get(id); return e?!!e.checked:false}
  function stamp(){const t=get('lastRefresh'); if(t) t.textContent=new Date().toLocaleString()}

  let s = read();
  // Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Øª Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  s.threshold = typeof s.threshold==='number'? s.threshold : 60;
  s.cooldown = typeof s.cooldown==='number'? s.cooldown : 3;
  s.rateLimit = typeof s.rateLimit==='number'? s.rateLimit : 20;
  s.mustInclude = s.mustInclude||'';
  s.mustExclude = s.mustExclude||'';
  s.normalizeArabic = (s.normalizeArabic!==false);
  s.enableOCR = (s.enableOCR!==false);
  s.instantEyes = (s.instantEyes!==false);
  s.timezone = s.timezone||'auto';
  s.apiBase = s.apiBase||'';
  s.apiKey = s.apiKey||'';
  write(s);

  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¥Ù† ÙˆÙØ¬Ø¯Øª
  setVal('threshold', s.threshold);
  setVal('cooldown', s.cooldown);
  setVal('rateLimit', s.rateLimit);
  setVal('mustInclude', s.mustInclude);
  setVal('mustExclude', s.mustExclude);
  setChk('normalizeArabic', s.normalizeArabic);
  setChk('enableOCR', s.enableOCR);
  setChk('instantEyes', s.instantEyes);
  setVal('timezone', s.timezone);
  setVal('apiBase', s.apiBase);
  setVal('apiKey', s.apiKey);
  stamp();

  // Ø­ÙØ¸ Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±
  ['threshold','cooldown','rateLimit','mustInclude','mustExclude','timezone','apiBase','apiKey']
    .forEach(id=>{ const e=get(id); if(e) e.addEventListener('change', ()=>{ s=read(); s[id]= (id==='threshold'||id==='cooldown'||id==='rateLimit')? Number(val(id)) : val(id,''); write(s); stamp(); }) });
  ['normalizeArabic','enableOCR','instantEyes']
    .forEach(id=>{ const e=get(id); if(e) e.addEventListener('change', ()=>{ s=read(); s[id]= chk(id); write(s); stamp(); }) });

  // ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ù…Ø¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª)
  const exp=get('exportSettings'); if(exp) exp.addEventListener('click',()=>{
    const data = { settings: read(), groups: (function(){try{return JSON.parse(localStorage.getItem(LS_GROUPS)||'[]')}catch{return []}})() };
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='bot_settings.json'; a.click(); URL.revokeObjectURL(url);
  });
  const imp=get('importSettings'); if(imp) imp.addEventListener('change', async (e)=>{
    const f=e.target.files&&e.target.files[0]; if(!f) return; const text=await f.text();
    try{
      const obj=JSON.parse(text);
      if(obj.settings){ write({...read(), ...obj.settings}); }
      if(Array.isArray(obj.groups)){ localStorage.setItem(LS_GROUPS, JSON.stringify(obj.groups)); }
      location.reload();
    }catch{ alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); }
  });

  // ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…
  const ping=get('pingServer'); if(ping) ping.addEventListener('click', async ()=>{
    const base=val('apiBase','').replace(/\/$/,''); const key=val('apiKey',''); const out=get('pingResult');
    if(!base){ alert('Ø£Ø¯Ø®Ù„ API Base'); return; }
    try{ const res=await fetch(base+'/health',{headers:{'Authorization':'Bearer '+key}});
      if(out) out.textContent = res.ok? 'âœ… Ù…ØªØµÙ„' : ('âŒ '+res.status);
      const sh=document.getElementById('serviceHealth'); if(sh) sh.textContent = res.ok? 'Ø³Ù„ÙŠÙ…' : 'ØºÙŠØ± Ù…ØªØ§Ø­';
    }catch{ if(out) out.textContent='âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„'; const sh=document.getElementById('serviceHealth'); if(sh) sh.textContent='ØºÙŠØ± Ù…ØªØ§Ø­'; }
  });
})();
// === Ø¥Ø¶Ø§ÙØ© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ù† ÙˆØ§ØªØ³Ø§Ø¨ (Modal + API) ===
(function(){
  // Ø§Ø³ØªØ®Ø¯Ù… Ø£Ø³Ù…Ø§Ø¡ Ù…ØªÙ…Ø§ÙŠØ²Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¹Ø§Ø±Ø¶
  let wa_allChats = [];
  let wa_selectedIds = [];

  function wa_openModal(){ if(els.groupsOverlay) els.groupsOverlay.style.display='flex'; wa_renderList(); }
  function wa_closeModal(){ if(els.groupsOverlay) els.groupsOverlay.style.display='none'; }

  async function wa_loadChats(){
    if(!els.apiBase || !els.apiBase.value){ return alert('Ø£Ø¯Ø®Ù„ API Base URL Ø£ÙˆÙ„Ø§Ù‹'); }
    const base = (els.apiBase.value||'').replace(/\/$/,'');
    els.chatsHint && (els.chatsHint.textContent='...Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„');
    try{
      const res = await fetch(base + '/chats', { headers: { 'Authorization': 'Bearer ' + (els.apiKey?.value||'') }});
      const data = await res.json();
      wa_allChats = Array.isArray(data) ? data.filter(c=>c && (c.isGroup!==false)) : [];
      // Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ø¨Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠØ© (groups Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯)
      const current = (function(){ try{return JSON.parse(localStorage.getItem('bot_groups_v1')||'[]')}catch{return []} })();
      const s = new Set(current);
      wa_selectedIds = wa_allChats.filter(c=> s.has(c.name)).map(c=> c.id);
      els.chatsHint && (els.chatsHint.textContent=`ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„: ${wa_allChats.length} Ù…Ø¬Ù…ÙˆØ¹Ø©`);
      wa_renderList();
    }catch(e){ els.chatsHint && (els.chatsHint.textContent='ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„'); }
  }

  function wa_renderList(){
    if(!els.chatsList) return;
    const q = (els.groupSearch?.value||'').toLowerCase();
    const list = wa_allChats.filter(c=> (c.name||'').toLowerCase().includes(q));
    els.chatsList.innerHTML='';
    list.forEach(c=>{
      const row=document.createElement('div'); row.className='list-item';
      const checked = wa_selectedIds.includes(c.id)?'checked':'';
      row.innerHTML = `<input type="checkbox" data-id="${c.id}" ${checked}/> <div style="flex:1">${escapeHtml(c.name||'')}</div> <span class="muted">${c.participants||0} Ø¹Ø¶Ùˆ</span>`;
      els.chatsList.appendChild(row);
    });
    if(els.selectedCount) els.selectedCount.textContent = String(wa_selectedIds.length);
    els.chatsList.querySelectorAll('input[type="checkbox"]').forEach(ch=>{
      ch.addEventListener('change',e=>{
        const id=e.target.getAttribute('data-id');
        if(e.target.checked){ if(!wa_selectedIds.includes(id)) wa_selectedIds.push(id); }
        else { wa_selectedIds = wa_selectedIds.filter(x=>x!==id); }
        if(els.selectedCount) els.selectedCount.textContent = String(wa_selectedIds.length);
      });
    });
  }

  // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
  els.closeGroupsModal && els.closeGroupsModal.addEventListener('click', wa_closeModal);
  els.refreshChats && els.refreshChats.addEventListener('click', wa_loadChats);
  els.groupSearch && els.groupSearch.addEventListener('input', wa_renderList);
  els.selectAllChats && els.selectAllChats.addEventListener('click', ()=>{ wa_selectedIds = wa_allChats.map(c=>c.id); wa_renderList(); });
  els.clearAllChats && els.clearAllChats.addEventListener('click', ()=>{ wa_selectedIds = []; wa_renderList(); });
  els.saveSelectedGroups && els.saveSelectedGroups.addEventListener('click', async ()=>{
    const base = (els.apiBase?.value||'').replace(/\/$/,'');
    try{
      await fetch(base + '/groups/select', { method:'POST', headers:{ 'Content-Type':'application/json','Authorization':'Bearer '+(els.apiKey?.value||'') }, body: JSON.stringify({ ids: wa_selectedIds }) });
    }catch(_){}
    const set = new Set(wa_selectedIds);
    const names = wa_allChats.filter(c=> set.has(c.id)).map(c=> c.name);
    localStorage.setItem('bot_groups_v1', JSON.stringify(names));
    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù… Ø¹Ù„Ù‰ Ø´ÙƒÙ„ tags
    if(typeof renderGroups==='function'){ window.groups = names; renderGroups(); }
    wa_closeModal();
  });

  // ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù…Ù† Ø²Ø± "Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† ÙˆØ§ØªØ³Ø§Ø¨"
  els.pickFromWhatsApp && els.pickFromWhatsApp.addEventListener('click', async ()=>{ await wa_loadChats(); wa_openModal(); });
  // Ø¨Ø¹Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ (Ù…Ø¨Ø¯Ø¦ÙŠÙ‹Ø§ Ù†Ø³Ù…Ø­ Ø¨Ø§Ù„ÙØªØ­ Ù…Ù† Ø²Ø± Ø§Ù„Ø±Ø¨Ø· Ø£ÙŠØ¶Ù‹Ø§)
  els.connectBtn && els.connectBtn.addEventListener('click', async ()=>{ await wa_loadChats(); wa_openModal(); });
})();
</script></body>
</html>
