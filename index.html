<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>لوحة تحكم بوت واتساب</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--blue:#0a84ff;--green:#34c759;--red:#ff3b30;--bg:#f7f7fb;--card:#fff;--muted:#64748b}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Tajawal",Arial,sans-serif;color:#0f172a}
    header{background:var(--blue);color:#fff;padding:14px 16px;text-align:center;font-weight:800}
    main{max-width:1000px;margin:16px auto;padding:0 12px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 8px 24px rgba(2,6,23,.06);padding:16px;margin-bottom:12px}
    h3{margin:0 0 10px;font-size:18px}
    label{display:block;font-weight:700;margin:.4rem 0}
    input,button,select{border-radius:12px;border:1px solid #e5e7eb;padding:10px 12px;font-size:15px}
    input,select{width:100%}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{background:var(--blue);color:#fff;border:none;cursor:pointer;font-weight:800}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-ghost{background:#eef2ff;color:#1e293b;border:0}
    .btn-red{background:var(--red)}
    .muted{color:var(--muted);font-size:13px}
    .state{display:inline-flex;gap:6px;align-items:center;background:#f3f4f6;padding:6px 10px;border-radius:999px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:920px){.grid{grid-template-columns:1fr}}
    /* Tags */
    #groupsTags{display:flex;gap:6px;flex-wrap:wrap}
    .tag{background:#eef2ff;border-radius:999px;padding:4px 10px;font-size:13px}
    /* Modal QR */
    #qrOverlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
    .qrCard{background:#fff;border-radius:16px;max-width:380px;width:92vw;padding:16px;box-shadow:0 20px 50px rgba(0,0,0,.2)}
    .qrHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .qrBox{min-height:300px;display:flex;align-items:center;justify-content:center;border:1px solid #eef2f7;border-radius:12px;overflow:hidden}
    /* Modal Groups */
    #groupsOverlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50}
    .groupsCard{background:#fff;border-radius:16px;max-width:780px;width:94vw;max-height:86vh;overflow:hidden;box-shadow:0 20px 50px rgba(0,0,0,.2);display:flex;flex-direction:column}
    .groupsHead{padding:12px 16px;border-bottom:1px solid #eef2f7;display:flex;gap:8px;align-items:center;justify-content:space-between}
    .groupsBody{padding:8px 12px;overflow:auto}
    .groupsFoot{padding:12px 16px;border-top:1px solid #eef2f7;display:flex;align-items:center;justify-content:space-between}
    .list-item{display:flex;gap:10px;align-items:center;border-bottom:1px solid #f3f4f6;padding:10px 6px}
  </style>
</head>
<body>
  <header>📱 لوحة تحكم بوت واتساب</header>

  <main>
    <div class="grid">
      <!-- إعدادات الخادم -->
      <section class="card">
        <h3>🔧 إعدادات الخادم</h3>
        <label>API Base URL</label>
        <input id="apiBase" placeholder="https://your-backend.onrender.com" />
        <label>API Key</label>
        <input id="apiKey" type="password" placeholder="أدخل المفتاح" />
        <div class="row">
          <button class="btn btn-ghost" id="pingServer">فحص الاتصال</button>
          <span class="state">الحالة: <strong id="serviceHealth">غير معروف</strong></span>
        </div>
        <div class="muted" id="pingResult">—</div>
      </section>

      <!-- اتصال واتساب -->
      <section class="card">
        <h3>🟢 اتصال واتساب</h3>
        <div class="row">
          <button class="btn" id="connectBtn">ربط واتساب (مسح QR)</button>
          <button class="btn btn-ghost" id="pickGroups">اختيار المجموعات</button>
          <span class="state">جلسة: <strong id="status">غير متصل</strong></span>
        </div>
        <p class="muted">بعد الاتصال يمكنك جلب المجموعات تلقائيًا من الباك-إند وحفظها.</p>
        <div class="muted" style="margin-top:8px">المجموعات المحددة:</div>
        <div id="groupsTags"></div>
      </section>
    </div>
  </main>

  <!-- Modal QR -->
  <div id="qrOverlay">
    <div class="qrCard" role="dialog" aria-modal="true">
      <div class="qrHead">
        <strong>امسح رمز واتساب</strong>
        <button id="closeQr" class="btn btn-red">إغلاق</button>
      </div>
      <div id="qrBox" class="qrBox">
        <span class="muted">جارِ جلب QR...</span>
      </div>
      <div id="qrHint" class="muted" style="margin-top:8px">افتح واتساب → الأجهزة المرتبطة → اربط جهازًا</div>
    </div>
  </div>

  <!-- Modal اختيار المجموعات -->
  <div id="groupsOverlay">
    <div class="groupsCard" role="dialog" aria-modal="true">
      <div class="groupsHead">
        <strong>اختيار المجموعات من واتساب</strong>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="groupSearch" placeholder="ابحث باسم المجموعة..." style="border:1px solid #e5e7eb;border-radius:12px;padding:8px 10px;width:46vw;max-width:360px">
          <button class="btn btn-ghost" id="refreshChats">تحديث</button>
          <button class="btn btn-ghost" id="selectAllChats">تحديد الكل</button>
          <button class="btn btn-ghost" id="clearAllChats">إلغاء الكل</button>
          <button class="btn btn-red" id="closeGroupsModal">إغلاق</button>
        </div>
      </div>
      <div id="chatsList" class="groupsBody"></div>
      <div class="groupsFoot">
        <span class="muted">المحدد حاليًا: <strong id="selectedCount">0</strong></span>
        <button class="btn" id="saveSelectedGroups">حفظ الاختيار</button>
      </div>
    </div>
  </div>

  <script>
  /* (B) زر فحص الاتصال */
  (function () {
    const btn = document.getElementById('pingServer');
    const resEl = document.getElementById('pingResult');
    const healthEl = document.getElementById('serviceHealth');
    if (!btn || !resEl || !healthEl) return;

    btn.addEventListener('click', async () => {
      const base = (document.getElementById('apiBase').value || '').trim().replace(/\/$/,'');
      const key  = (document.getElementById('apiKey').value  || '').trim();
      if(!base || !key){ resEl.textContent='❌ أدخل API Base و API Key'; return; }
      resEl.textContent = '⏳ جارِ الفحص...';
      try {
        const res  = await fetch(base + '/health', { headers: { Authorization: 'Bearer ' + key } });
        resEl.textContent    = res.ok ? '✅ متصل' : ('❌ ' + res.status);
        healthEl.textContent = res.ok ? 'سليم' : 'غير متاح';
      } catch (e) {
        resEl.textContent    = '❌ فشل الاتصال: ' + e.message;
        healthEl.textContent = 'غير متاح';
      }
    });
  })();

  /* مودال QR وربط واتساب */
  (function(){
    const apiBaseEl = document.getElementById('apiBase');
    const apiKeyEl  = document.getElementById('apiKey');
    const connectBtn = document.getElementById('connectBtn');
    const qrOverlay = document.getElementById('qrOverlay');
    const qrBox = document.getElementById('qrBox');
    const closeQr = document.getElementById('closeQr');
    const statusEl = document.getElementById('status');

    let pollTimer = null;

    function openQR(){ qrOverlay.style.display = 'flex'; }
    function closeQR(){
      qrOverlay.style.display = 'none';
      if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
    }
    closeQr?.addEventListener('click', closeQR);

    async function fetchQR(base, key){
      try{
        const res = await fetch(base + '/session/qr', { headers: { Authorization: 'Bearer ' + key }});
        if (res.ok) {
          const data = await res.json();
          if (data.qr) {
            qrBox.innerHTML = `<img src="${data.qr}" alt="QR" style="width:100%;max-width:320px;display:block">`;
            return 'qr';
          }
          if (data.message === 'Already connected') return 'connected';
        }
      }catch(_){}
      qrBox.innerHTML = `<span class="muted">لا يوجد QR حاليًا… سيُعاد المحاولة</span>`;
      return 'waiting';
    }

    async function checkReady(base, key){
      try{
        const res = await fetch(base + '/health', { headers: { Authorization: 'Bearer ' + key }});
        if (!res.ok) return false;
        const data = await res.json();
        return !!data.isReady;
      }catch(_){ return false; }
    }

    async function startQrFlow(){
      const base = (apiBaseEl.value || '').trim().replace(/\/$/,'');
      const key  = (apiKeyEl.value  || '').trim();
      if (!base || !key) return alert('أدخل API Base و API Key');
      openQR();
      const first = await fetchQR(base, key);
      if (first === 'connected') {
        qrBox.innerHTML = '<span class="muted">متصل مسبقًا ✅</span>';
        statusEl.textContent = 'متصل';
        setTimeout(closeQR, 900);
        return;
      }
      pollTimer = setInterval(async () => {
        const ready = await checkReady(base, key);
        if (ready) {
          qrBox.innerHTML = '<span class="muted">تم الاتصال ✅</span>';
          statusEl.textContent = 'متصل';
          clearInterval(pollTimer); pollTimer = null;
          setTimeout(closeQR, 800);
          return;
        }
        await fetchQR(base, key);
      }, 3000);
    }

    connectBtn?.addEventListener('click', startQrFlow);
  })();

  /* مراقب حالة الجلسة (يحدّث النص تلقائيًا) */
  (function(){
    const statusEl   = document.getElementById('status');
    const healthEl   = document.getElementById('serviceHealth');
    const pingResult = document.getElementById('pingResult');
    const apiBaseEl  = document.getElementById('apiBase');
    const apiKeyEl   = document.getElementById('apiKey');
    let watchTimer = null;

    function setSessionUI(isReady){
      if (!statusEl) return;
      statusEl.textContent = isReady ? 'متصل' : 'غير متصل';
    }
    async function fetchHealth(){
      const base = (apiBaseEl.value||'').trim().replace(/\/$/,'');
      const key  = (apiKeyEl.value ||'').trim();
      if(!base || !key) return;
      try{
        const res  = await fetch(base + '/health', { headers: { Authorization: 'Bearer ' + key }});
        if(!res.ok){ setSessionUI(false); healthEl && (healthEl.textContent='غير متاح'); return; }
        const data = await res.json();
        setSessionUI(!!data.isReady);
        healthEl && (healthEl.textContent = 'سليم');
        pingResult && (pingResult.textContent = '✅ متصل');
      }catch(_){
        setSessionUI(false);
        healthEl && (healthEl.textContent='غير متاح');
        pingResult && (pingResult.textContent='❌ فشل الاتصال');
      }
    }
    function startStatusWatcher(){
      if (watchTimer) clearInterval(watchTimer);
      fetchHealth();
      watchTimer = setInterval(fetchHealth, 5000);
    }
    startStatusWatcher();
    const pingBtn = document.getElementById('pingServer');
    if (pingBtn) pingBtn.addEventListener('click', () => setTimeout(startStatusWatcher, 300));
    const closeQr = document.getElementById('closeQr');
    if (closeQr) closeQr.addEventListener('click', () => setTimeout(startStatusWatcher, 800));
  })();

  /* مودال اختيار المجموعات */
  (function(){
    // عناصر
    const apiBaseEl = document.getElementById('apiBase');
    const apiKeyEl  = document.getElementById('apiKey');
    const pickBtn   = document.getElementById('pickGroups');
    const tagsBox   = document.getElementById('groupsTags');

    const overlay   = document.getElementById('groupsOverlay');
    const closeBtn  = document.getElementById('closeGroupsModal');
    const searchEl  = document.getElementById('groupSearch');
    const listEl    = document.getElementById('chatsList');
    const refreshEl = document.getElementById('refreshChats');
    const allEl     = document.getElementById('selectAllChats');
    const noneEl    = document.getElementById('clearAllChats');
    const saveEl    = document.getElementById('saveSelectedGroups');
    const counterEl = document.getElementById('selectedCount');

    let allChats = [];
    let selectedIds = [];
    let selectedNames = [];
    const LS_KEY = 'bot_groups_names_v1';

    function open(){ overlay.style.display = 'flex'; }
    function close(){ overlay.style.display = 'none'; }
    function escapeHtml(s){ return (s||'').replace(/[&<>'"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;' }[m])); }

    function renderTags(){
      if(!tagsBox) return;
      tagsBox.innerHTML = '';
      selectedNames.forEach(n=>{
        const t=document.createElement('div');
        t.className='tag';
        t.textContent = n;
        tagsBox.appendChild(t);
      });
    }

    function renderList(){
      const q=(searchEl.value||'').toLowerCase();
      const list = allChats.filter(c=> (c.name||'').toLowerCase().includes(q));
      listEl.innerHTML='';
      list.forEach(c=>{
        const row=document.createElement('div');
        row.className='list-item';
        const checked = selectedIds.includes(c.id) ? 'checked' : '';
        row.innerHTML = `
          <input type="checkbox" data-id="${c.id}" ${checked}/>
          <div style="flex:1">${escapeHtml(c.name||'')}</div>
          <span class="muted">${c.participants||0} عضو</span>
        `;
        listEl.appendChild(row);
      });
      counterEl.textContent = String(selectedIds.length);
      listEl.querySelectorAll('input[type="checkbox"]').forEach(ch=>{
        ch.addEventListener('change', e=>{
          const id = e.target.getAttribute('data-id');
          if (e.target.checked) { if(!selectedIds.includes(id)) selectedIds.push(id); }
          else { selectedIds = selectedIds.filter(x=>x!==id); }
          counterEl.textContent = String(selectedIds.length);
        });
      });
    }

    async function loadChats(){
      const base=(apiBaseEl.value||'').trim().replace(/\/$/,'');
      const key =(apiKeyEl.value||'').trim();
      if(!base||!key){ alert('أدخل API Base و API Key'); return; }
      listEl.innerHTML = '<div class="muted" style="padding:12px">...جاري تحميل المجموعات</div>';
      try{
        const res = await fetch(base + '/chats', { headers:{ Authorization:'Bearer '+key }});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        allChats = Array.isArray(data) ? data.filter(c=>c && c.isGroup!==false) : [];
        const saved = JSON.parse(localStorage.getItem(LS_KEY)||'[]');
        const set   = new Set(saved);
        selectedIds   = allChats.filter(c=> set.has(c.name)).map(c=>c.id);
        selectedNames = saved;
        renderList();
        renderTags();
      }catch(e){
        listEl.innerHTML = `<div class="muted" style="padding:12px">تعذّر التحميل: ${e.message}</div>`;
      }
    }

    pickBtn?.addEventListener('click', async ()=>{ await loadChats(); open(); });
    closeBtn?.addEventListener('click', close);
    searchEl?.addEventListener('input', renderList);
    refreshEl?.addEventListener('click', loadChats);
    allEl?.addEventListener('click', ()=>{ selectedIds = allChats.map(c=>c.id); renderList(); });
    noneEl?.addEventListener('click', ()=>{ selectedIds = []; renderList(); });

    saveEl?.addEventListener('click', async ()=>{
      const base=(apiBaseEl.value||'').trim().replace(/\/$/,'');
      const key =(apiKeyEl.value||'').trim();
      const idSet = new Set(selectedIds);
      selectedNames = allChats.filter(c=> idSet.has(c.id)).map(c=> c.name);
      localStorage.setItem(LS_KEY, JSON.stringify(selectedNames));
      renderTags();
      try{
        await fetch(base + '/groups/select', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+key },
          body: JSON.stringify({ ids: selectedIds })
        });
      }catch(_){}
      close();
    });
  })();
  </script>
</body>
</html>
