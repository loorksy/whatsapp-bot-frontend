<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>بوت واتساب — iOS</title>
<style>
  :root{
    --bg:#f2f2f7; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --border:#e5e7eb;
    --blue:#0a84ff; --green:#34c759; --red:#ff3b30; --shadow:0 8px 24px rgba(2,6,23,.06);
    --chip:#f3f4f6; --ghost:#eef2ff;
  }
  .dark{
    --bg:#0b0f14; --card:#0f141a; --text:#e5e7eb; --muted:#94a3b8; --border:#1f2937;
    --blue:#0a84ff; --green:#34c759; --red:#ff5547; --shadow:0 8px 30px rgba(0,0,0,.45);
    --chip:#111827; --ghost:#1f2937;
  }
  @media (prefers-color-scheme: dark){ :root{ color-scheme:dark } }

  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Tajawal",Arial,sans-serif}

  header{position:sticky;top:0;z-index:10;background:var(--card);padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:8px}
  header h1{margin:0;font-size:18px;font-weight:800}
  .badge{display:inline-flex;gap:6px;align-items:center;background:var(--chip);border-radius:999px;padding:6px 10px;font-size:13px}

  main{max-width:980px;margin:12px auto;padding:0 12px 68px}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}

  .card{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:14px}
  h3{margin:0 0 8px;font-size:16px}
  .muted{color:var(--muted);font-size:13px}

  label{display:block;font-weight:700;margin:.35rem 0 .25rem}
  input,select,textarea,button{width:100%;font-size:15px;border:1px solid var(--border);border-radius:12px;background:var(--card);color:var(--text);padding:11px 12px}
  textarea{min-height:96px;resize:vertical}

  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .stack{flex-direction:column} .stack>*{width:100%}
  @media(min-width:900px){.stack{flex-direction:row}.stack>*{width:auto}}

  .btn{background:var(--blue);color:#fff;border:none;border-radius:12px;padding:11px 14px;font-weight:800;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn-ghost{background:var(--ghost);color:var(--text)}
  .btn-green{background:var(--green)} .btn-red{background:var(--red)}
  .state{display:inline-flex;gap:6px;align-items:center;background:var(--chip);padding:6px 10px;border-radius:999px}

  .btn-col{display:grid;grid-template-columns:1fr;gap:8px}
  @media(min-width:900px){.btn-col{grid-template-columns:repeat(3,auto)}}

  .switch{position:relative;width:52px;height:30px} .switch input{display:none}
  .track{position:absolute;inset:0;background:var(--border);border-radius:999px;transition:.2s}
  .thumb{position:absolute;top:3px;right:3px;width:24px;height:24px;background:#fff;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,.15);transition:.2s}
  .dark .thumb{background:#e5e7eb}
  .switch input:checked + .track{background:var(--green)} .switch input:checked + .track .thumb{right:25px}

  #groupsTags{display:flex;gap:6px;flex-wrap:wrap}
  .tag{background:var(--ghost);border-radius:999px;padding:4px 10px;font-size:13px}

  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:60}
  .sheet{background:var(--card);width:min(92vw,380px);max-height:86vh;border-radius:18px;box-shadow:0 20px 50px rgba(0,0,0,.35);overflow:hidden}
  .sheet-lg{width:min(94vw,780px)}
  .sheet .head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border)}
  .sheet .body{padding:12px 14px}
  .sheet .foot{padding:12px 14px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:space-between;align-items:center}
  .sheet{display:flex;flex-direction:column}
  .sheet .body{flex:1;overflow:auto}
  .sheet .foot{position:sticky;bottom:0;background:var(--card)}

  #toast{position:fixed;bottom:16px;right:16px;left:16px;margin:auto;max-width:420px;background:#111827;color:#fff;padding:12px 14px;border-radius:14px;box-shadow:var(--shadow);display:none;z-index:80}
  #toast.ok{background:#065f46} #toast.err{background:#7f1d1d}
</style>
</head>
<body>
  <header>
    <h1>بوت واتساب — iOS</h1>
    <div class="row" style="gap:10px">
      <div class="badge">جلسة: <strong id="status">غير متصل</strong></div>
      <button class="btn btn-ghost" id="openLogs">السجل 📝</button>
      <label class="switch" title="الوضع الداكن">
        <input id="darkToggle" type="checkbox"><span class="track"><span class="thumb"></span></span>
      </label>
    </div>
  </header>

  <main>
    <div class="grid">
      <!-- الجلسة والمجموعات -->
      <section class="card">
        <h3>🟢 الجلسة</h3>
        <div class="btn-col">
          <button class="btn" id="connectBtn">اتصال (QR)</button>
          <button class="btn btn-ghost" id="pickGroups">مجموعات</button>
          <button class="btn btn-ghost" id="refreshGroups">تحديث</button>
        </div>
        <div class="state" style="margin-top:8px">الحالة: <strong id="statusChip">غير متصل</strong></div>
        <div class="muted" style="margin-top:8px">المحدد:</div>
        <div id="groupsTags"></div>
      </section>

      <!-- العملاء -->
      <section class="card">
        <h3>👤 العملاء</h3>
        <label>لصق دفعة (سطر/عميل، أو "الاسم,الإيموجي")</label>
        <textarea id="bulkClients" placeholder="حسين محمد الخالد,✅"></textarea>
        <div class="btn-col" style="margin-top:8px">
          <button class="btn btn-ghost" id="applyClients">حفظ</button>
          <button class="btn btn-ghost" id="clearClients">مسح</button>
        </div>
        <label style="margin-top:10px">CSV (Sheets)</label>
        <input id="sheetUrl" placeholder="رابط CSV">
        <button class="btn btn-ghost" id="importSheet" style="margin-top:8px">استيراد</button>
        <p class="muted">القائمة تُحفظ محليًا لهذا الجهاز.</p>
      </section>
    </div>

    <div class="grid">
      <!-- التفاعل -->
      <section class="card">
        <h3>⚡ التفاعل</h3>
        <div class="stack row">
          <select id="mode">
            <option value="emoji">إيموجي</option>
            <option value="text">نص</option>
          </select>
          <input id="emoji" value="✅" />
          <input id="replyText" value="تم ✅" style="display:none" />
        </div>

        <div class="stack row" style="margin-top:8px">
          <input id="threshold" type="number" min="40" max="95" value="60" placeholder="تطابق %"/>
          <input id="cooldown"  type="number" min="0"  max="300" value="3"  placeholder="مهلة ث"/>
          <input id="rateLimit" type="number" min="1"  max="120" value="20" placeholder="/دقيقة"/>
        </div>

        <input id="mustInclude" placeholder="يتطلب كلمات" style="margin-top:8px">
        <input id="mustExclude" placeholder="يستبعد كلمات" style="margin-top:8px">

        <div class="stack row" style="margin-top:8px">
          <label class="switch"><input id="normalizeArabic" type="checkbox" checked><span class="track"><span class="thumb"></span></span></label><span class="muted">تطبيع عربي</span>
          <label class="switch"><input id="enableOCR" type="checkbox"><span class="track"><span class="thumb"></span></span></label><span class="muted">OCR صور</span>
          <label class="switch"><input id="instantEyes" type="checkbox" checked><span class="track"><span class="thumb"></span></span></label><span class="muted">👀 فوري</span>
          <label class="switch"><input id="dryRun" type="checkbox"><span class="track"><span class="thumb"></span></span></label><span class="muted">تجريبي</span>
        </div>

        <!-- أرشيف -->
        <div class="stack row" style="margin-top:8px">
          <label class="switch"><input id="historyOnStart" type="checkbox"><span class="track"><span class="thumb"></span></span></label>
          <span class="muted">أرشيف عند البدء</span>
          <input id="historyLimit" type="number" min="10" max="1000" value="200" placeholder="حد الأرشيف">
          <button class="btn btn-ghost" id="scanHistoryNow" style="margin-inline-start:auto">فحص الأرشيف الآن</button>
        </div>

        <div class="btn-col" style="margin-top:10px">
          <button class="btn btn-green" id="startBtn">بدء</button>
          <button class="btn btn-red" id="stopBtn">إيقاف</button>
          <span class="state">التشغيل: <strong id="runState">متوقف</strong></span>
        </div>
      </section>
    </div>
  </main>

  <!-- مودال QR -->
  <div class="overlay" id="qrOverlay">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="head">
        <strong>مسح QR</strong>
        <button id="closeQr" class="btn btn-red">إغلاق</button>
      </div>
      <div class="body">
        <div id="qrBox" style="min-height:300px;display:flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:12px">
          <span class="muted">جارِ جلب QR...</span>
        </div>
        <div class="muted" style="margin-top:8px">واتساب → الأجهزة المرتبطة → ربط جهاز</div>
      </div>
    </div>
  </div>

  <!-- مودال المجموعات -->
  <div class="overlay" id="groupsOverlay">
    <div class="sheet sheet-lg" role="dialog" aria-modal="true">
      <div class="head">
        <strong>المجموعات</strong>
        <div class="row" style="gap:6px">
          <input id="groupSearch" placeholder="بحث..." style="width:46vw;max-width:360px">
          <button class="btn btn-ghost" id="refreshChats">تحديث</button>
          <button class="btn btn-ghost" id="selectAllChats">الكل</button>
          <button class="btn btn-ghost" id="clearAllChats">إلغاء</button>
          <button class="btn btn-red" id="closeGroupsModal">إغلاق</button>
        </div>
      </div>
      <div class="body" id="chatsList" style="max-height:56vh;overflow:auto"></div>
      <div class="foot">
        <span class="muted">المحدد: <strong id="selectedCount">0</strong></span>
        <button class="btn" id="saveSelectedGroups">حفظ</button>
      </div>
    </div>
  </div>

  <!-- مودال السجل -->
  <div class="overlay" id="logsOverlay">
    <div class="sheet sheet-lg" role="dialog" aria-modal="true">
      <div class="head">
        <strong>سجل الأحداث</strong>
        <button id="closeLogs" class="btn btn-red">إغلاق</button>
      </div>
      <div class="body" id="logsBody" style="max-height:65vh;overflow:auto;font-size:13px"></div>
    </div>
  </div>

  <div id="toast"></div>

<script>
/* ===== إعدادات افتراضية (بدون إدخال يدوي) ===== */
const DEFAULT_API_BASE = 'https://whatsapp-bot-backend-1jdi.onrender.com';
const DEFAULT_API_KEY  = 'ahmad_SUPER_secret_2025';

/* ===== Helpers & Storage ===== */
const LS={api:'bot_api_v1',groupsNames:'bot_groups_names_v1',clients:'bot_clients_v1',settings:'bot_settings_v1',theme:'bot_theme_v1'};
const $=id=>document.getElementById(id);
const toast=(m,t='ok')=>{const x=$('toast');x.className='';x.classList.add(t==='ok'?'ok':'err');x.textContent=m;x.style.display='block';setTimeout(()=>x.style.display='none',2200)};
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const load=(k,d)=>{try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(d))}catch{return d}};
const esc=s=>(s||'').replace(/[&<>'"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[m]));

/* ===== Theme ===== */
(function(){
  const t=load(LS.theme,{dark:null}); const prefersDark=window.matchMedia('(prefers-color-scheme: dark)').matches;
  if(t.dark===true || (t.dark===null && prefersDark)) document.body.classList.add('dark');
  $('darkToggle').checked=document.body.classList.contains('dark');
  $('darkToggle').addEventListener('change',()=>{document.body.classList.toggle('dark',$('darkToggle').checked); save(LS.theme,{dark:$('darkToggle').checked});});
})();

/* ===== Session/Health ===== */
function setSessionUI(ok){ const s=ok?'متصل':'غير متصل'; $('status').textContent=s; $('statusChip').textContent=s; }
async function health(){
  try{const r=await fetch(DEFAULT_API_BASE+'/health'); if(!r.ok) return {ok:false}; const d=await r.json(); return {ok:true,ready:!!d.isReady};}
  catch{return {ok:false}}
}
let watchTimer=null;
async function startWatcher(){ if(watchTimer) clearInterval(watchTimer); const tick=async()=>{ const h=await health(); setSessionUI(h.ok && h.ready); }; await tick(); watchTimer=setInterval(tick,5000); }
startWatcher();

/* ===== Mode toggle (emoji/text) ===== */
(function(){ const sync=()=>{ $('emoji').style.display=$('mode').value==='emoji'?'block':'none'; $('replyText').style.display=$('mode').value==='text'?'block':'none'; }; $('mode').addEventListener('change',sync); sync(); })();

/* ===== QR flow ===== */
function openQR(){ $('qrOverlay').style.display='flex' } function closeQR(){ $('qrOverlay').style.display='none' }
$('closeQr').addEventListener('click',closeQR);
async function fetchQR(){
  try{const r=await fetch(DEFAULT_API_BASE+'/session/qr',{headers:{Authorization:'Bearer '+DEFAULT_API_KEY}});
    if(r.ok){const d=await r.json(); if(d.qr){$('qrBox').innerHTML=`<img src="${d.qr}" style="width:100%;max-width:320px;display:block">`; return 'qr'}
      if(d.message==='Already connected') return 'connected'}
  }catch{}
  $('qrBox').innerHTML='<span class="muted">لا يوجد QR… سيُعاد</span>'; return 'waiting';
}
async function checkReady(){ const h=await health(); return h.ok && h.ready; }
$('connectBtn').addEventListener('click',async()=>{
  openQR(); let first=await fetchQR();
  if(first==='connected'){ $('qrBox').innerHTML='<span class="muted">متصل ✅</span>'; setSessionUI(true); setTimeout(closeQR,900); return }
  const poll=setInterval(async()=>{ if(await checkReady()){ $('qrBox').innerHTML='<span class="muted">تم ✅</span>'; setSessionUI(true); clearInterval(poll); setTimeout(closeQR,800) } else { await fetchQR() } },3000);
});

/* ===== Groups Modal ===== */
const groupsOverlay=$('groupsOverlay'), chatsList=$('chatsList'), groupSearch=$('groupSearch'), refreshChats=$('refreshChats'),
  selectAllChats=$('selectAllChats'), clearAllChats=$('clearAllChats'), closeGroupsModal=$('closeGroupsModal'),
  saveSelectedGroups=$('saveSelectedGroups'), selectedCount=$('selectedCount'), groupsTags=$('groupsTags');

let allChats=[], selectedIds=[], selectedNames=load(LS.groupsNames,[]);
function renderTags(){ groupsTags.innerHTML=''; selectedNames.forEach(n=>{const t=document.createElement('div');t.className='tag';t.textContent=n;groupsTags.appendChild(t)}); }
renderTags();
function openGroups(){ groupsOverlay.style.display='flex' } function closeGroups(){ groupsOverlay.style.display='none' }
closeGroupsModal.addEventListener('click',closeGroups);

function renderList(){
  const q=(groupSearch.value||'').toLowerCase();
  const list=allChats.filter(c=>(c.name||'').toLowerCase().includes(q));
  chatsList.innerHTML='';
  list.forEach(c=>{
    const row=document.createElement('div');
    row.className='row';
    row.style.cssText='justify-content:space-between;border-bottom:1px solid var(--border);padding:8px 4px';
    const checked=selectedIds.includes(c.id)?'checked':'';
    row.innerHTML=`<label class="row" style="gap:10px"><input type="checkbox" data-id="${c.id}" ${checked}><span>${esc(c.name||'')}</span></label><span class="muted">${c.participants||0} عضو</span>`;
    chatsList.appendChild(row);
  });
  selectedCount.textContent=String(selectedIds.length);
  chatsList.querySelectorAll('input[type="checkbox"]').forEach(ch=>{
    ch.addEventListener('change',e=>{
      const id=e.target.getAttribute('data-id');
      if(e.target.checked){ if(!selectedIds.includes(id)) selectedIds.push(id) } else { selectedIds=selectedIds.filter(x=>x!==id) }
      selectedCount.textContent=String(selectedIds.length);
    });
  });
}
async function loadChats(){
  chatsList.innerHTML='<div class="muted" style="padding:8px">...تحميل</div>';
  try{
    const r=await fetch(DEFAULT_API_BASE+'/chats',{headers:{Authorization:'Bearer '+DEFAULT_API_KEY}});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const data=await r.json();
    allChats=(Array.isArray(data)?data:[]).filter(c=>c&&c.isGroup!==false);
    const set=new Set(selectedNames);
    selectedIds=allChats.filter(c=>set.has(c.name)).map(c=>c.id);
    renderList();
  }catch(e){
    chatsList.innerHTML=`<div class="muted" style="padding:8px">تعذّر: ${e.message}</div>`;
  }
}
$('pickGroups').addEventListener('click',async()=>{ await loadChats(); openGroups(); });
$('refreshGroups').addEventListener('click',async()=>{ await loadChats(); openGroups(); });
refreshChats.addEventListener('click',loadChats);
groupSearch.addEventListener('input',renderList);
selectAllChats.addEventListener('click',()=>{ selectedIds=allChats.map(c=>c.id); renderList(); });
clearAllChats.addEventListener('click',()=>{ selectedIds=[]; renderList(); });

saveSelectedGroups.addEventListener('click',async()=>{
  const set=new Set(selectedIds);
  selectedNames = allChats.filter(c=>set.has(c.id)).map(c=>c.name);
  save(LS.groupsNames,selectedNames); renderTags();
  try{
    await fetch(DEFAULT_API_BASE+'/groups/select',{
      method:'POST',
      headers:{'Content-Type':'application/json',Authorization:'Bearer '+DEFAULT_API_KEY},
      body: JSON.stringify({ ids: selectedIds })
    });
    toast('تم الحفظ ✅','ok');
  }catch{ toast('حُفظ محليًا','err') }
  closeGroups();
});

/* ===== Clients ===== */
function parseClients(text){
  const lines=(text||'').split(/\n+/).map(s=>s.trim()).filter(Boolean); const out=[]; const seen=new Set();
  for(const l of lines){ let name=l,emoji=''; if(l.includes(',')){const [n,e]=l.split(','); name=(n||'').trim(); emoji=(e||'').trim()}
    const key=name.replace(/\s+/g,' ').trim(); if(!key||seen.has(key)) continue; seen.add(key); out.push({name:key,emoji}) }
  return out;
}
$('applyClients').addEventListener('click',()=>{const list=parseClients($('bulkClients').value); save(LS.clients,list); toast(`حُفظ ${list.length} عميل ✅`,'ok')});
$('clearClients').addEventListener('click',()=>{$('bulkClients').value=''; save(LS.clients,[]); toast('تم المسح','ok')});
$('importSheet').addEventListener('click',async()=>{const url=($('sheetUrl').value||'').trim(); if(!url) return toast('ضع رابط CSV','err'); try{const r=await fetch(url); const t=await r.text(); const lines=t.split(/\r?\n/).filter(x=>x.trim()); $('bulkClients').value=lines.join('\n'); toast('CSV جاهز — احفظ','ok')}catch{toast('تعذّر CSV','err')}});

<script>
// Helpers آمنة للوصول للحقول
function valOf(id, def=''){
  const el = document.getElementById(id);
  return (el && 'value' in el) ? (el.value ?? def) : def;
}
function chkOf(id, def=false){
  const el = document.getElementById(id);
  return (el && 'checked' in el) ? !!el.checked : def;
}
function setV(id, val){
  const el = document.getElementById(id);
  if (el && 'value' in el) el.value = val;
}
function setC(id, val){
  const el = document.getElementById(id);
  if (el && 'checked' in el) el.checked = !!val;
}

// ⬇️ احفظ الإعدادات بطريقة تتحمل غياب أي عنصر
function persistSettings(){
  const s = {
    mode:         valOf('mode','emoji'),
    emoji:        valOf('emoji','✅'),
    replyText:    valOf('replyText','تم ✅'),
    threshold:   +valOf('threshold',60) || 60,
    cooldown:    +valOf('cooldown',3)  || 3,
    rateLimit:   +valOf('rateLimit',20)|| 20,
    mustInclude:  valOf('mustInclude',''),
    mustExclude:  valOf('mustExclude',''),
    normalizeArabic: chkOf('normalizeArabic',true),
    enableOCR:       chkOf('enableOCR',false),
    instantEyes:     chkOf('instantEyes',true),
    dryRun:          chkOf('dryRun',false),
    timezone:    valOf('timezone','auto'),
    startDate:   valOf('startDate',''),
    startTime:   valOf('startTime',''),
    // الحقول الاختيارية (لو غير موجودة لا مشكلة)
    historyOnStart:  chkOf('historyOnStart',false),
    historyLimit:   +valOf('historyLimit',200) || 200,
  };
  localStorage.setItem('bot_settings_v1', JSON.stringify(s));
  return s;
}

// ⬇️ حمّل الإعدادات بأمان (ما يعتمد على وجود كل العناصر)
(function preloadSettings(){
  const raw = localStorage.getItem('bot_settings_v1');
  let s = {};
  try { s = raw ? JSON.parse(raw) : {}; } catch { s = {}; }

  setV('mode',      s.mode      ?? 'emoji');
  setV('emoji',     s.emoji     ?? '✅');
  setV('replyText', s.replyText ?? 'تم ✅');
  setV('threshold', s.threshold ?? 60);
  setV('cooldown',  s.cooldown  ?? 3);
  setV('rateLimit', s.rateLimit ?? 20);
  setV('mustInclude', s.mustInclude ?? '');
  setV('mustExclude', s.mustExclude ?? '');
  setC('normalizeArabic', s.normalizeArabic ?? true);
  setC('enableOCR',       s.enableOCR       ?? false);
  setC('instantEyes',     s.instantEyes     ?? true);
  setC('dryRun',          s.dryRun          ?? false);
  setV('timezone', s.timezone ?? 'auto');
  setV('startDate', s.startDate ?? '');
  setV('startTime', s.startTime ?? '');
  // اختياريين
  setC('historyOnStart', s.historyOnStart ?? false);
  setV('historyLimit',   s.historyLimit   ?? 200);

  // مزامنة إظهار حقل الإيموجي/النص
  const modeEl = document.getElementById('mode');
  const emojiEl = document.getElementById('emoji');
  const replyEl = document.getElementById('replyText');
  const sync = () => {
    if (!modeEl || !emojiEl || !replyEl) return;
    emojiEl.style.display  = (modeEl.value === 'emoji') ? 'block' : 'none';
    replyEl.style.display  = (modeEl.value === 'text')  ? 'block' : 'none';
  };
  modeEl?.addEventListener('change', sync);
  sync();
})();
</script>
</body>
</html>
