<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>لوحة تحكم بوت واتساب</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--blue:#0a84ff;--green:#34c759;--red:#ff3b30;--bg:#f7f7fb;--card:#fff;--muted:#64748b}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Tajawal",Arial,sans-serif;color:#0f172a}
    header{background:var(--blue);color:#fff;padding:14px 16px;text-align:center;font-weight:800}
    main{max-width:920px;margin:16px auto;padding:0 12px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 8px 24px rgba(2,6,23,.06);padding:16px;margin-bottom:12px}
    h3{margin:0 0 10px;font-size:18px}
    label{display:block;font-weight:700;margin:.4rem 0}
    input,button,select{border-radius:12px;border:1px solid #e5e7eb;padding:10px 12px;font-size:15px}
    input,select{width:100%}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{background:var(--blue);color:#fff;border:none;cursor:pointer;font-weight:800}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-ghost{background:#eef2ff;color:#1e293b;border:0}
    .btn-red{background:var(--red)}
    .muted{color:var(--muted);font-size:13px}
    .state{display:inline-flex;gap:6px;align-items:center;background:#f3f4f6;padding:6px 10px;border-radius:999px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:860px){.grid{grid-template-columns:1fr}}
    /* Modal */
    #qrOverlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
    .qrCard{background:#fff;border-radius:16px;max-width:380px;width:92vw;padding:16px;box-shadow:0 20px 50px rgba(0,0,0,.2)}
    .qrHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .qrBox{min-height:300px;display:flex;align-items:center;justify-content:center;border:1px solid #eef2f7;border-radius:12px;overflow:hidden}
  </style>
</head>
<body>
  <header>📱 لوحة تحكم بوت واتساب</header>
  <main>

    <div class="grid">
      <!-- إعدادات الخادم -->
      <section class="card">
        <h3>🔧 إعدادات الخادم</h3>
        <label>API Base URL</label>
        <input id="apiBase" placeholder="https://your-backend.onrender.com" />
        <label>API Key</label>
        <input id="apiKey" type="password" placeholder="أدخل المفتاح" />
        <div class="row">
          <button class="btn btn-ghost" id="pingServer">فحص الاتصال</button>
          <span class="state">الحالة: <strong id="serviceHealth">غير معروف</strong></span>
        </div>
        <div class="muted" id="pingResult">—</div>
      </section>

      <!-- اتصال واتساب -->
      <section class="card">
        <h3>🟢 اتصال واتساب</h3>
        <div class="row">
          <button class="btn" id="connectBtn">ربط واتساب (مسح QR)</button>
          <span class="state">جلسة: <strong id="status">غير متصل</strong></span>
        </div>
        <p class="muted">بعد الاتصال يمكنك لاحقًا جلب المجموعات تلقائيًا من الباك-إند.</p>
      </section>
    </div>

    <!-- يمكنك إضافة أقسام الإعدادات/العملاء لاحقًا ونحن نطوّرها خطوة بخطوة -->

  </main>

  <!-- Modal QR -->
  <div id="qrOverlay">
    <div class="qrCard" role="dialog" aria-modal="true">
      <div class="qrHead">
        <strong>امسح رمز واتساب</strong>
        <button id="closeQr" class="btn btn-red">إغلاق</button>
      </div>
      <div id="qrBox" class="qrBox">
        <span class="muted">جارِ جلب QR...</span>
      </div>
      <div id="qrHint" class="muted" style="margin-top:8px">افتح واتساب → الأجهزة المرتبطة → اربط جهازًا</div>
    </div>
  </div>

  <script>
  /* (B) زر فحص الاتصال */
  (function () {
    const btn = document.getElementById('pingServer');
    const resEl = document.getElementById('pingResult');
    const healthEl = document.getElementById('serviceHealth');
    if (!btn || !resEl || !healthEl) return;

    btn.addEventListener('click', async () => {
      const base = (document.getElementById('apiBase').value || '').trim().replace(/\/$/,'');
      const key  = (document.getElementById('apiKey').value  || '').trim();
      if(!base || !key){ resEl.textContent='❌ أدخل API Base و API Key'; return; }
      resEl.textContent = '⏳ جارِ الفحص...';
      try {
        const res  = await fetch(base + '/health', { headers: { Authorization: 'Bearer ' + key } });
        resEl.textContent    = res.ok ? '✅ متصل' : ('❌ ' + res.status);
        healthEl.textContent = res.ok ? 'سليم' : 'غير متاح';
      } catch (e) {
        resEl.textContent    = '❌ فشل الاتصال: ' + e.message;
        healthEl.textContent = 'غير متاح';
      }
    });
  })();

  /* مودال QR وربط واتساب */
  (function(){
    const apiBaseEl = document.getElementById('apiBase');
    const apiKeyEl  = document.getElementById('apiKey');
    const connectBtn = document.getElementById('connectBtn');
    const qrOverlay = document.getElementById('qrOverlay');
    const qrBox = document.getElementById('qrBox');
    const closeQr = document.getElementById('closeQr');
    const statusEl = document.getElementById('status');

    let pollTimer = null;

    function openQR(){ qrOverlay.style.display = 'flex'; }
    function closeQR(){
      qrOverlay.style.display = 'none';
      if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
    }
    closeQr?.addEventListener('click', closeQR);

    async function fetchQR(base, key){
      try{
        const res = await fetch(base + '/session/qr', { headers: { Authorization: 'Bearer ' + key }});
        if (res.ok) {
          const data = await res.json();
          if (data.qr) {
            qrBox.innerHTML = `<img src="${data.qr}" alt="QR" style="width:100%;max-width:320px;display:block">`;
            return 'qr';
          }
          if (data.message === 'Already connected') return 'connected';
        }
      }catch(_){}
      qrBox.innerHTML = `<span class="muted">لا يوجد QR حاليًا… سيُعاد المحاولة</span>`;
      return 'waiting';
    }

    async function checkReady(base, key){
      try{
        const res = await fetch(base + '/health', { headers: { Authorization: 'Bearer ' + key }});
        if (!res.ok) return false;
        const data = await res.json();
        return !!data.isReady;
      }catch(_){ return false; }
    }

    async function startQrFlow(){
      const base = (apiBaseEl.value || '').trim().replace(/\/$/,'');
      const key  = (apiKeyEl.value  || '').trim();
      if (!base || !key) return alert('أدخل API Base و API Key');
      openQR();
      const first = await fetchQR(base, key);
      if (first === 'connected') {
        qrBox.innerHTML = '<span class="muted">متصل مسبقًا ✅</span>';
        statusEl.textContent = 'متصل';
        setTimeout(closeQR, 900);
        return;
      }
      pollTimer = setInterval(async () => {
        const ready = await checkReady(base, key);
        if (ready) {
          qrBox.innerHTML = '<span class="muted">تم الاتصال ✅</span>';
          statusEl.textContent = 'متصل';
          clearInterval(pollTimer); pollTimer = null;
          setTimeout(closeQR, 800);
          return;
        }
        await fetchQR(base, key);
      }, 3000);
    }

    connectBtn?.addEventListener('click', startQrFlow);
  })();
  </script>
  <script>
(function(){
  const statusEl   = document.getElementById('status');       // النص: متصل/غير متصل
  const healthEl   = document.getElementById('serviceHealth'); // النص: سليم/غير متاح
  const pingResult = document.getElementById('pingResult');    // نتيجة فحص الاتصال
  const apiBaseEl  = document.getElementById('apiBase');
  const apiKeyEl   = document.getElementById('apiKey');

  let watchTimer = null;

  function setSessionUI(isReady){
    if (!statusEl) return;
    statusEl.textContent = isReady ? 'متصل' : 'غير متصل';
    // لو عندك نقطة ملوّنة، بدّلها هنا (مثال بسيط):
    // document.getElementById('sessionDot').style.background = isReady ? '#34c759' : '#ff3b30';
  }

  async function fetchHealth(){
    const base = (apiBaseEl.value||'').trim().replace(/\/$/,'');
    const key  = (apiKeyEl.value ||'').trim();
    if(!base || !key) return;
    try{
      const res  = await fetch(base + '/health', { headers: { Authorization: 'Bearer ' + key }});
      if(!res.ok){ setSessionUI(false); healthEl && (healthEl.textContent='غير متاح'); return; }
      const data = await res.json();
      setSessionUI(!!data.isReady);
      healthEl && (healthEl.textContent = 'سليم');
      pingResult && (pingResult.textContent = '✅ متصل');
    }catch(_){
      setSessionUI(false);
      healthEl && (healthEl.textContent='غير متاح');
      pingResult && (pingResult.textContent='❌ فشل الاتصال');
    }
  }

  // ابدأ المراقبة كل 5 ثواني
  function startStatusWatcher(){
    if (watchTimer) clearInterval(watchTimer);
    fetchHealth(); // فحص فوري أولاً
    watchTimer = setInterval(fetchHealth, 5000);
  }

  // شغّل المراقب عند تحميل الصفحة وبعد أي فحص/ربط
  startStatusWatcher();

  // لو زر فحص الاتصال موجود، خلّصته يعيد تشغيل المراقب بعد الفحص
  const pingBtn = document.getElementById('pingServer');
  if (pingBtn) {
    pingBtn.addEventListener('click', () => {
      setTimeout(startStatusWatcher, 300); // أعِد تشغيل المراقب
    });
  }

  // ولو زر ربط واتساب موجود، شغّل المراقب بعد ما تغلق مودال QR
  const closeQr = document.getElementById('closeQr');
  if (closeQr) {
    closeQr.addEventListener('click', () => {
      setTimeout(startStatusWatcher, 800);
    });
  }
})();
</script>
</body>
</html>
